<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roll Off Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: { slate: { 850: '#172033', 900: '#0f172a', 950: '#020617' } },
                    animation: { 'fade-in': 'fadeIn 0.4s ease-out forwards', 'ping-slow': 'ping 2s cubic-bezier(0, 0, 0.2, 1) infinite' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }
        .gloss-panel { background: linear-gradient(180deg, rgba(30, 41, 59, 0.7) 0%, rgba(15, 23, 42, 0.8) 100%); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08); border-top: 1px solid rgba(255, 255, 255, 0.15); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5), inset 0 1px 0 0 rgba(255, 255, 255, 0.1); }
        .gloss-card { background: linear-gradient(180deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.01) 100%); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: all 0.2s ease; position: relative; overflow: hidden; cursor: pointer; z-index: 10; }
        .gloss-card:hover { background: linear-gradient(180deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.02) 100%); transform: translateY(-3px); box-shadow: 0 20px 40px -5px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.1); border-top-color: rgba(255,255,255,0.3); z-index: 20; }
        .input-gloss { background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); border-top: 1px solid rgba(0, 0, 0, 0.5); box-shadow: inset 0 2px 4px rgba(0,0,0,0.2); color: white; transition: all 0.2s; }
        .input-gloss:focus { background: rgba(0, 0, 0, 0.5); border-color: #6366f1; box-shadow: inset 0 2px 4px rgba(0,0,0,0.3), 0 0 0 2px rgba(99, 102, 241, 0.3); outline: none; }
        .btn-gloss { position: relative; background-image: linear-gradient(to bottom, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 100%); border-top: 1px solid rgba(255,255,255,0.4); border-bottom: 1px solid rgba(0,0,0,0.2); box-shadow: 0 4px 6px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.2); transition: all 0.1s; }
        .btn-gloss:active { transform: translateY(1px); }
        .nav-pill-active { background: linear-gradient(180deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.05) 100%); box-shadow: 0 2px 10px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.1); text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 font-sans selection:bg-indigo-500/50 overflow-x-hidden min-h-screen relative">
    <div class="fixed inset-0 z-0 pointer-events-none overflow-hidden">
        <div class="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] bg-indigo-600/30 rounded-full mix-blend-screen filter blur-[100px] animate-blob"></div>
        <div class="absolute top-[10%] right-[-10%] w-[50%] h-[50%] bg-blue-600/20 rounded-full mix-blend-screen filter blur-[100px] animate-blob animation-delay-2000"></div>
        <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjZmZmIiBmaWxsLW9wYWNpdHk9IjAuMDIiLz4KPC9zdmc+')] opacity-20"></div>
    </div>
    <div id="root" class="relative z-10"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const firebaseConfig = {apiKey: "AIzaSyAkDUZZnh_AoKhBe-ntB1I4-QJKyiaEeg8", authDomain: "rollcall-e5e3a.firebaseapp.com", projectId: "rollcall-e5e3a", storageBucket: "rollcall-e5e3a.firebasestorage.app", messagingSenderId: "301776745476", appId: "1:301776745476:web:49d23434d590135c7df151"};
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const db = firebase.firestore(); const storage = firebase.storage(); const auth = firebase.auth();
        db.enablePersistence({ synchronizeTabs: true }).catch(err => console.log(err.code));

        const DEPOTS = ['Jersey City', 'Bronx', 'Brooklyn'];
        const Icons = {
            Truck: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2"/><path d="M15 18H9"/><path d="M19 18h2a1 1 0 0 0 1-1v-3.65a1 1 0 0 0-.22-.624l-3.48-4.35A1 1 0 0 0 17.52 8H14"/><circle cx="17" cy="18" r="2"/><circle cx="7" cy="18" r="2"/></svg>,
            Wrench: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>,
            Sun: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>,
            Moon: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>,
            Trash2: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            Plus: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Save: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"/><path d="M17 21v-8H7v8"/><path d="M7 3v5h8"/></svg>,
            CheckCircle: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            XCircle: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>,
            Activity: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>,
            AlertTriangle: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>,
            Database: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>,
            Wifi: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></svg>,
            WifiOff: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="1" y1="1" x2="23" y2="23"/><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"/><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"/><path d="M10.71 5.05A16 16 0 0 1 22.58 9"/><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></svg>,
            Zap: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
            Home: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
            ListTodo: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="5" width="6" height="6" rx="1"/><path d="m3 17 2 2 4-4"/><path d="M13 6h8"/><path d="M13 12h8"/><path d="M13 18h8"/></svg>,
            Calendar: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>,
            Square: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="3" rx="2" /></svg>,
            CheckSquare: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>,
            Users: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            Pencil: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>,
            ChevronLeft: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m15 18-6-6 6-6"/></svg>,
            ChevronRight: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m9 18 6-6-6-6"/></svg>,
            Clock: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            Plane: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20.38 3.4a1.6 1.6 0 0 0-2.26 0l-1.88 1.88L8.5 3.33a1.32 1.32 0 0 0-1.8 1.8l1.95 7.74-6.2 3.1a1 1 0 0 0 .1 1.8l6.3 1.7 1.7 6.3a1 1 0 0 0 1.8.1l3.1-6.2 7.74 1.95a1.32 1.32 0 0 0 1.8-1.8l-1.88-1.88a1.6 1.6 0 0 0 0-2.26z"/></svg>,
            Siren: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M7 12a5 5 0 0 1 5-5v0a5 5 0 0 1 5 5v6H7v-6Z"/><path d="M5 20a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v2H5v-2Z"/><path d="M21 12h1"/><path d="M18.5 4.5 18 5"/><path d="M2 12h1"/><path d="M5.5 4.5 6 5"/></svg>,
            CalendarDays: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></svg>,
            ClipboardCheck: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="m9 14 2 2 4-4"/></svg>,
            History: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></svg>,
            Archive: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="20" height="5" x="2" y="3" rx="1"/><path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8"/><path d="M10 12h4"/></svg>,
            FileText: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>,
            Upload: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            Map: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/><line x1="9" x2="9" y1="3" y2="18"/><line x1="15" x2="15" y1="6" y2="21"/></svg>,
            Paperclip: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>,
            Spinner: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={`animate-spin ${className}`}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
            Calculator: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>,
            Box: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22.08V12"/></svg>,
            MessageCircle: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>,
            Send: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>,
            X: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 6 6 18"/><path d="m6 6 18 18"/></svg>
        };

        const getLocalDateString = (date) => { const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; };
        const getStartOfWeek = (date) => { const d = new Date(date); const day = d.getDay(); const diff = d.getDate() - day + (day === 0 ? -6 : 1); return new Date(d.setDate(diff)); };
        const isValidDriver = (id, drivers) => { return id && drivers.some(d => d.id === id && d.status !== 'Archived'); };
        const StatusBadge = ({ status }) => {
            const safeStatus = status || 'Active'; const styles = { Active: 'bg-emerald-500 text-white shadow-[0_0_10px_rgba(16,185,129,0.5)]', Down: 'bg-red-500 text-white shadow-[0_0_10px_rgba(239,68,68,0.5)]', Shop: 'bg-amber-500 text-white shadow-[0_0_10px_rgba(245,158,11,0.5)]'}; const icons = { Active: <Icons.CheckCircle className="w-3 h-3 mr-1" />, Down: <Icons.XCircle className="w-3 h-3 mr-1" />, Shop: <Icons.Wrench className="w-3 h-3 mr-1" />};
            return (<span className={`flex items-center px-3 py-0.5 rounded-full text-[10px] font-bold uppercase tracking-wider border border-white/20 ${styles[safeStatus] || styles.Active}`}>{icons[safeStatus] || icons.Active}{safeStatus}</span>);
        };

        const getHolidays = (year) => {
            const holidays = [
                { date: `${year}-01-01`, title: "New Year's Day", type: "Holiday" },
                { date: `${year}-07-04`, title: "Independence Day", type: "Holiday" },
                { date: `${year}-11-11`, title: "Veterans Day", type: "Holiday" },
                { date: `${year}-12-25`, title: "Christmas Day", type: "Holiday" }
            ];
            // Simple calculation for floating holidays
            const getNthDay = (y, m, dayOfWeek, n) => {
                const date = new Date(y, m, 1);
                let count = 0;
                while (date.getMonth() === m) {
                    if (date.getDay() === dayOfWeek) {
                        count++;
                        if (count === n) return getLocalDateString(date);
                    }
                    date.setDate(date.getDate() + 1);
                }
            };
            const getLastDay = (y, m, dayOfWeek) => {
                const date = new Date(y, m + 1, 0);
                while (date.getDay() !== dayOfWeek) date.setDate(date.getDate() - 1);
                return getLocalDateString(date);
            };

            // Memorial Day (Last Mon May)
            holidays.push({ date: getLastDay(year, 4, 1), title: "Memorial Day", type: "Holiday" });
            // Labor Day (1st Mon Sept)
            holidays.push({ date: getNthDay(year, 8, 1, 1), title: "Labor Day", type: "Holiday" });
            // Thanksgiving (4th Thu Nov)
            holidays.push({ date: getNthDay(year, 10, 4, 4), title: "Thanksgiving", type: "Holiday" });

            return holidays;
        };

        const ChatWidget = () => {
            const [isOpen, setIsOpen] = useState(false);
            const [username, setUsername] = useState(localStorage.getItem('chat_username') || '');
            const [hasJoined, setHasJoined] = useState(!!localStorage.getItem('chat_username'));
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState("");
            const [unread, setUnread] = useState(false);
            const scrollRef = useRef();
            const lastMsgCount = useRef(0);

            useEffect(() => {
                const unsub = db.collection('chat_messages').orderBy('createdAt', 'asc').limit(50).onSnapshot(snapshot => {
                    const newMsgs = snapshot.docs.map(d => d.data());
                    setMessages(newMsgs);
                    // Check if new message arrived while closed
                    if (newMsgs.length > lastMsgCount.current) {
                        if (!isOpen && lastMsgCount.current > 0) { setUnread(true); }
                    }
                    lastMsgCount.current = newMsgs.length;
                });
                return () => unsub();
            }, [isOpen]);

            useEffect(() => {
                if(isOpen && scrollRef.current) {
                    scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
                    setUnread(false);
                }
            }, [messages, isOpen]);

            const handleJoin = (e) => { e.preventDefault(); if(!username.trim()) return; localStorage.setItem('chat_username', username); setHasJoined(true); };
            const handleSend = (e) => { e.preventDefault(); if(!input.trim()) return; db.collection('chat_messages').add({ text: input, user: username, createdAt: firebase.firestore.FieldValue.serverTimestamp() }); setInput(""); };

            return (
                <div className="fixed bottom-6 right-6 z-50 flex flex-col items-end gap-4">
                    {isOpen && (
                        <div className="gloss-panel w-80 h-96 rounded-2xl flex flex-col shadow-2xl animate-fade-in overflow-hidden border border-white/20">
                            <div className="p-4 bg-slate-900/80 border-b border-white/10 flex justify-between items-center backdrop-blur-md">
                                <h3 className="font-bold text-white flex items-center"><span className="w-2 h-2 rounded-full bg-emerald-500 mr-2 animate-pulse"></span> Live Chat</h3>
                                <button onClick={() => setIsOpen(false)} className="text-slate-400 hover:text-white"><Icons.X className="w-5 h-5"/></button>
                            </div>
                            {!hasJoined ? (
                                <div className="flex-1 flex flex-col justify-center p-6 text-center">
                                    <h4 className="text-white font-bold mb-2">Identify Yourself</h4>
                                    <p className="text-xs text-slate-400 mb-4">Enter your name to join the comms channel.</p>
                                    <form onSubmit={handleJoin} className="flex flex-col gap-2">
                                        <input type="text" autoFocus className="input-gloss rounded-lg p-3 text-center" placeholder="Your Name" value={username} onChange={e => setUsername(e.target.value)} />
                                        <button type="submit" className="bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-500 transition-colors btn-gloss">Join Chat</button>
                                    </form>
                                </div>
                            ) : (
                                <>
                                    <div className="flex-1 overflow-y-auto p-4 space-y-3 custom-scroll bg-slate-900/30" ref={scrollRef}>
                                        {messages.map((msg, idx) => {
                                            const isMe = msg.user === username;
                                            return (
                                                <div key={idx} className={`flex flex-col ${isMe ? 'items-end' : 'items-start'}`}>
                                                    <div className={`max-w-[85%] rounded-xl p-3 text-sm shadow-sm ${isMe ? 'bg-blue-600 text-white rounded-br-none' : 'bg-slate-700 text-slate-200 rounded-bl-none'}`}>
                                                        {!isMe && <div className="text-[10px] font-bold text-blue-300 mb-1">{msg.user}</div>}
                                                        {msg.text}
                                                    </div>
                                                </div>
                                            )
                                        })}
                                    </div>
                                    <form onSubmit={handleSend} className="p-3 bg-slate-900/80 border-t border-white/10 flex gap-2 backdrop-blur-md">
                                        <input type="text" className="flex-1 input-gloss rounded-lg px-3 py-2 text-sm" placeholder="Message..." value={input} onChange={e => setInput(e.target.value)} />
                                        <button type="submit" className="p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-500 transition-colors shadow-lg"><Icons.Send className="w-4 h-4"/></button>
                                    </form>
                                </>
                            )}
                        </div>
                    )}
                    <button onClick={() => setIsOpen(!isOpen)} className={`h-14 w-14 rounded-full flex items-center justify-center shadow-2xl transition-all hover:scale-110 btn-gloss relative ${isOpen ? 'bg-slate-800 text-slate-300' : 'bg-blue-600 text-white shadow-blue-500/40'}`}>
                        <Icons.MessageCircle className="w-7 h-7" />
                        {!isOpen && unread && <span className="absolute top-0 right-0 h-4 w-4 rounded-full bg-red-500 border-2 border-slate-900 animate-ping-slow"></span>}
                        {!isOpen && unread && <span className="absolute top-0 right-0 h-4 w-4 rounded-full bg-red-500 border-2 border-slate-900"></span>}
                    </button>
                </div>
            );
        };

        const TruckCard = ({ truck, drivers, onUpdate, onDelete, onClick }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [editData, setEditData] = useState({ ...truck });
            const handleSave = () => { const cleanData = { ...editData, dayDriverId: editData.dayDriverId === "" ? null : editData.dayDriverId, nightDriverId: editData.nightDriverId === "" ? null : editData.nightDriverId }; onUpdate(truck.id, cleanData); setIsEditing(false); };
            const activeDrivers = drivers.filter(d => d.status !== 'Archived');
            const dayDrivers = activeDrivers.filter(d => (d.shift === 'Day' || !d.shift));
            const nightDrivers = activeDrivers.filter(d => d.shift === 'Night');
            if (isEditing) {
                return (
                    <div className="gloss-panel rounded-2xl p-6 shadow-2xl animate-fade-in relative z-30" onClick={(e)=>e.stopPropagation()}>
                        <div className="flex justify-between items-start mb-6"><h3 className="text-xl font-bold text-white drop-shadow-lg">Edit {truck.number}</h3><button onClick={() => setIsEditing(false)} className="text-slate-400 hover:text-white transition-colors"><Icons.XCircle className="w-6 h-6" /></button></div>
                        <div className="space-y-4">
                            <div><label className="text-xs text-blue-300 font-bold uppercase tracking-wide mb-1 block">Status</label><select className="w-full input-gloss rounded-lg p-3 text-sm" value={editData.status} onChange={(e) => setEditData({...editData, status: e.target.value})}><option value="Active">Active</option><option value="Down">Down (Broken)</option><option value="Shop">In Shop</option></select></div>
                            <div><label className="text-xs text-blue-300 font-bold uppercase tracking-wide mb-1 block">Depot</label><select className="w-full input-gloss rounded-lg p-3 text-sm" value={editData.depot || 'Jersey City'} onChange={(e) => setEditData({...editData, depot: e.target.value})}>{DEPOTS.map(d => <option key={d} value={d}>{d}</option>)}</select></div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="text-xs text-amber-400 font-bold uppercase tracking-wide mb-1 flex items-center"><Icons.Sun className="w-3 h-3 mr-1"/> Day Driver</label><select className="w-full input-gloss rounded-lg p-3 text-sm" value={editData.dayDriverId || ''} onChange={(e) => setEditData({...editData, dayDriverId: e.target.value})}><option value="">Unassigned</option>{dayDrivers.map(d => <option key={d.id} value={d.id}>{d.name}</option>)}</select></div>
                                <div><label className="text-xs text-indigo-400 font-bold uppercase tracking-wide mb-1 flex items-center"><Icons.Moon className="w-3 h-3 mr-1"/> Night Driver</label><select className="w-full input-gloss rounded-lg p-3 text-sm" value={editData.nightDriverId || ''} onChange={(e) => setEditData({...editData, nightDriverId: e.target.value})}><option value="">Unassigned</option>{nightDrivers.map(d => <option key={d.id} value={d.id}>{d.name}</option>)}</select></div>
                            </div>
                            <div><label className="text-xs text-slate-400 font-bold uppercase tracking-wide mb-1 block">Notes</label><textarea className="w-full input-gloss rounded-lg p-3 text-sm h-24 resize-none" value={editData.notes || ''} placeholder="Any issues or comments..." onChange={(e) => setEditData({...editData, notes: e.target.value})} /></div>
                            <div className="flex justify-end gap-3 pt-4 border-t border-white/10"><button onClick={() => onDelete(truck.id)} className="px-4 py-2 bg-red-600 text-white rounded-lg text-xs font-bold uppercase tracking-wide flex items-center transition-colors btn-gloss"><Icons.Trash2 className="w-3 h-3 mr-2" /> Delete</button><button onClick={handleSave} className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg text-xs font-bold uppercase tracking-wide flex items-center shadow-lg shadow-indigo-500/20 transition-all btn-gloss"><Icons.Save className="w-3 h-3 mr-2" /> Save Changes</button></div>
                        </div>
                    </div>
                );
            }
            const dayDriver = isValidDriver(truck.dayDriverId, drivers) ? drivers.find(d => d.id === truck.dayDriverId) : null;
            const nightDriver = isValidDriver(truck.nightDriverId, drivers) ? drivers.find(d => d.id === truck.nightDriverId) : null;
            const isDoubleShifted = dayDriver && nightDriver;
            return (
                <div className={`relative group gloss-card rounded-2xl p-5 cursor-pointer ${truck.status === 'Down' ? 'border-red-500/40 bg-red-900/10' : ''}`} onClick={onClick}>
                    <div className="flex justify-between items-start mb-4">
                        <div className="flex items-center gap-3">
                            <div className={`h-12 w-12 rounded-xl flex items-center justify-center font-black text-xl shadow-inner border border-white/10 ${truck.status === 'Down' ? 'bg-gradient-to-b from-red-900 to-red-950 text-red-400' : 'bg-gradient-to-b from-slate-700 to-slate-900 text-slate-200'}`}>{truck.number.replace(/\D/g,'')}</div>
                            <div><h3 className="font-bold text-white text-lg leading-tight tracking-tight drop-shadow-md">{truck.number}</h3><StatusBadge status={truck.status} /></div>
                        </div>
                        <button onClick={(e) => {e.stopPropagation(); setIsEditing(true)}} className="text-slate-400 hover:text-indigo-400 transition-colors p-1 rounded hover:bg-slate-800"><Icons.Wrench className="w-5 h-5" /></button>
                    </div>
                    <div className="space-y-2 mt-4">
                        <div className="flex justify-between items-center px-3 py-2 rounded-lg bg-slate-900/40 border border-white/5 shadow-inner"><div className="flex items-center text-xs font-bold text-amber-500/90 uppercase tracking-wider"><Icons.Sun className="w-3 h-3 mr-2" /> Day</div><span className={`text-sm font-medium truncate max-w-[100px] ${dayDriver ? 'text-white' : 'text-slate-600 italic'}`}>{dayDriver ? dayDriver.name : 'Open'}</span></div>
                        <div className="flex justify-between items-center px-3 py-2 rounded-lg bg-slate-900/40 border border-white/5 shadow-inner"><div className="flex items-center text-xs font-bold text-indigo-400/90 uppercase tracking-wider"><Icons.Moon className="w-3 h-3 mr-2" /> Night</div><span className={`text-sm font-medium truncate max-w-[100px] ${nightDriver ? 'text-white' : 'text-slate-600 italic'}`}>{nightDriver ? nightDriver.name : 'Open'}</span></div>
                    </div>
                    {truck.notes && <div className="mt-3 px-3 py-2 bg-red-500/20 border border-red-500/20 rounded-lg text-xs text-red-200 flex items-start shadow-lg shadow-red-900/20"><Icons.AlertTriangle className="w-3 h-3 mr-2 mt-0.5 flex-shrink-0"/> <span className="line-clamp-2">{truck.notes}</span></div>}
                    {isDoubleShifted && truck.status === 'Active' && <div className="absolute -top-1 -right-1"><span className="flex h-3 w-3 relative"><span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span><span className="relative inline-flex rounded-full h-3 w-3 bg-green-500 box-shadow-lg shadow-green-500/50"></span></span></div>}
                </div>
            );
        };

        const FullCalendar = ({ events, onAddEvent, onDeleteEvent }) => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [selectedDate, setSelectedDate] = useState(null);
            const [newEventTitle, setNewEventTitle] = useState("");
            const [newEventTime, setNewEventTime] = useState("");

            const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
            const getFirstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const daysInMonth = getDaysInMonth(year, month);
            const firstDay = getFirstDayOfMonth(year, month);

            const holidays = getHolidays(year);
            const allEvents = [...events, ...holidays];

            const handlePrevMonth = () => setCurrentDate(new Date(year, month - 1));
            const handleNextMonth = () => setCurrentDate(new Date(year, month + 1));

            const handleAdd = (e) => {
                e.preventDefault();
                if (!newEventTitle || !selectedDate) return;
                onAddEvent({
                    title: newEventTitle,
                    time: newEventTime,
                    date: selectedDate,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                setNewEventTitle("");
                setNewEventTime("");
                setSelectedDate(null);
            };

            const renderCalendarCells = () => {
                const cells = [];
                // Empty cells for padding
                for (let i = 0; i < firstDay; i++) {
                    cells.push(<div key={`empty-${i}`} className="h-32 bg-slate-900/30 border border-white/5"></div>);
                }
                // Days
                for (let d = 1; d <= daysInMonth; d++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    const dayEvents = allEvents.filter(e => e.date === dateStr);
                    const isToday = dateStr === getLocalDateString(new Date());

                    cells.push(
                        <div key={d} className={`h-32 border border-white/5 p-2 relative group hover:bg-white/5 transition-colors ${isToday ? 'bg-blue-900/20' : 'bg-slate-900/50'}`} onClick={() => setSelectedDate(dateStr)}>
                            <div className={`text-sm font-bold mb-1 ${isToday ? 'text-blue-400' : 'text-slate-400'}`}>{d}</div>
                            <div className="space-y-1 overflow-y-auto max-h-[85px] custom-scroll">
                                {dayEvents.map((evt, idx) => (
                                    <div key={idx} className={`text-[10px] p-1 rounded truncate flex justify-between items-center group/evt ${evt.type === 'Holiday' ? 'bg-red-900/40 text-red-300 border border-red-500/20' : 'bg-blue-600 text-white'}`}>
                                        <span>{evt.time && <span className="opacity-70 mr-1">{evt.time}</span>}{evt.title}</span>
                                        {evt.type !== 'Holiday' && <button onClick={(e) => { e.stopPropagation(); onDeleteEvent(evt.id); }} className="hidden group-hover/evt:block hover:text-red-200"><Icons.X className="w-3 h-3" /></button>}
                                    </div>
                                ))}
                            </div>
                            <button className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 text-slate-500 hover:text-white transition-opacity"><Icons.Plus className="w-4 h-4" /></button>
                        </div>
                    );
                }
                return cells;
            };

            return (
                <div className="max-w-7xl mx-auto space-y-6 animate-fade-in pb-20">
                    <div className="flex justify-between items-center gloss-panel p-4 rounded-2xl">
                        <div className="flex items-center gap-4">
                            <button onClick={handlePrevMonth} className="p-2 hover:bg-white/10 rounded-full text-slate-400 hover:text-white transition-colors"><Icons.ChevronLeft className="w-6 h-6"/></button>
                            <h2 className="text-2xl font-bold text-white flex items-center gap-3 w-48 justify-center">{currentDate.toLocaleString('default', { month: 'long', year: 'numeric' })}</h2>
                            <button onClick={handleNextMonth} className="p-2 hover:bg-white/10 rounded-full text-slate-400 hover:text-white transition-colors"><Icons.ChevronRight className="w-6 h-6"/></button>
                        </div>
                        <button onClick={() => setSelectedDate(getLocalDateString(new Date()))} className="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg font-bold shadow-lg btn-gloss">Add Event</button>
                    </div>

                    <div className="gloss-panel rounded-2xl overflow-hidden shadow-2xl">
                        <div className="grid grid-cols-7 bg-slate-900 border-b border-white/10">
                            {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (
                                <div key={day} className="py-3 text-center text-slate-400 text-xs font-bold uppercase tracking-wider">{day}</div>
                            ))}
                        </div>
                        <div className="grid grid-cols-7">
                            {renderCalendarCells()}
                        </div>
                    </div>

                    {selectedDate && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-lg flex items-center justify-center z-50 p-4 animate-fade-in" onClick={() => setSelectedDate(null)}>
                            <div className="gloss-panel rounded-2xl p-6 w-full max-w-sm shadow-2xl" onClick={e => e.stopPropagation()}>
                                <h3 className="text-xl font-bold text-white mb-4">Add Event for {selectedDate}</h3>
                                <form onSubmit={handleAdd} className="space-y-4">
                                    <input type="text" autoFocus placeholder="Event Title" className="w-full input-gloss rounded-lg p-3" value={newEventTitle} onChange={e => setNewEventTitle(e.target.value)} />
                                    <input type="time" className="w-full input-gloss rounded-lg p-3" value={newEventTime} onChange={e => setNewEventTime(e.target.value)} />
                                    <div className="flex gap-3 pt-2">
                                        <button type="button" onClick={() => setSelectedDate(null)} className="flex-1 py-3 rounded-lg bg-slate-800 text-slate-300 font-bold hover:bg-slate-700">Cancel</button>
                                        <button type="submit" className="flex-1 py-3 rounded-lg bg-blue-600 text-white font-bold hover:bg-blue-500 shadow-lg">Add Event</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const TruckProfile = ({ truck, logs = [], hoistChecks = [], onBack, onAddLog, onDeleteLog, onCheckHoist }) => {
            const [newLog, setNewLog] = useState({ date: getLocalDateString(new Date()), type: 'Maintenance', notes: '', mechanic: '' });
            const currentMonth = new Date().toISOString().slice(0, 7);
            const isHoistChecked = hoistChecks.some(h => h.truckId === truck.id && h.month === currentMonth);
            const handleAddLog = (e) => { e.preventDefault(); if(!newLog.notes) return; onAddLog({...newLog, truckId: truck.id}); setNewLog({...newLog, notes: '', mechanic: ''}); };
            const handleHoistCheck = () => { if(window.confirm("Confirm Hoist Alarm is functional?")) { onCheckHoist({ truckId: truck.id, month: currentMonth, date: getLocalDateString(new Date()) }); } };
            return (
                <div className="space-y-8 animate-fade-in w-full relative z-20">
                    <button onClick={onBack} className="flex items-center text-slate-400 hover:text-white mb-6 px-4 py-2 rounded-full bg-slate-800/50 hover:bg-slate-700 transition-all w-fit btn-gloss text-sm"><Icons.ChevronLeft className="w-4 h-4 mr-1"/> Back to Fleet</button>
                    <div className="gloss-panel rounded-3xl p-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-6 shadow-2xl">
                        <div className="flex items-center gap-6">
                            <div className="h-24 w-24 rounded-2xl bg-gradient-to-br from-slate-700 to-slate-950 flex items-center justify-center text-slate-300 font-black text-4xl border border-white/20 shadow-2xl shadow-black/50">{truck.number.replace(/\D/g,'')}</div>
                            <div>
                                <h1 className="text-5xl font-black text-white tracking-tight drop-shadow-md">{truck.number}</h1>
                                <div className="flex items-center gap-3 mt-3">
                                    <StatusBadge status={truck.status} />
                                    <span className="text-slate-500 text-sm font-mono">ID: {truck.id ? truck.id.substring(0,6) : '...'}</span>
                                    <span className="text-xs font-bold text-slate-400 uppercase bg-slate-800 px-2 py-1 rounded">{truck.depot || 'Jersey City'}</span>
                                </div>
                            </div>
                        </div>
                        <div className={`p-5 rounded-2xl border min-w-[240px] flex flex-col items-center justify-center transition-all shadow-inner ${isHoistChecked ? 'bg-emerald-900/20 border-emerald-500/30' : 'bg-red-900/20 border-red-500/30'}`}>
                            <div className="text-xs uppercase font-bold tracking-widest mb-1 text-slate-400">Hoist Alarm Check</div>
                            <div className="text-lg font-bold text-white mb-3">{new Date().toLocaleString('default', { month: 'long' })}</div>
                            {isHoistChecked ? (<div className="flex items-center text-emerald-400 font-bold bg-emerald-900/40 px-4 py-1.5 rounded-full border border-emerald-500/30 shadow-[0_0_15px_rgba(16,185,129,0.3)]"><Icons.CheckCircle className="w-5 h-5 mr-2"/> COMPLIANT</div>) : (<button onClick={handleHoistCheck} className="bg-red-600 hover:bg-red-500 text-white px-6 py-2 rounded-full text-sm font-bold shadow-lg shadow-red-600/30 animate-pulse transition-all btn-gloss">MARK CHECKED</button>)}
                        </div>
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div className="lg:col-span-2 gloss-panel rounded-2xl p-6">
                            <h3 className="text-xl font-bold text-white mb-6 flex items-center border-b border-white/10 pb-4"><Icons.Wrench className="w-5 h-5 mr-3 text-orange-500"/> Maintenance Log</h3>
                            <form onSubmit={handleAddLog} className="flex flex-col gap-3 mb-8 bg-slate-900/30 p-5 rounded-xl border border-white/5 shadow-inner">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <input type="date" value={newLog.date} onChange={e => setNewLog({...newLog, date: e.target.value})} className="input-gloss rounded-lg p-3 text-sm"/>
                                    <select value={newLog.type} onChange={e => setNewLog({...newLog, type: e.target.value})} className="input-gloss rounded-lg p-3 text-sm"><option>Maintenance</option><option>Breakdown</option><option>Inspection</option><option>Tires</option></select>
                                </div>
                                <input type="text" placeholder="Mechanic / Shop Name" value={newLog.mechanic} onChange={e => setNewLog({...newLog, mechanic: e.target.value})} className="input-gloss rounded-lg p-3 text-sm"/>
                                <textarea placeholder="Description of work performed..." value={newLog.notes} onChange={e => setNewLog({...newLog, notes: e.target.value})} className="input-gloss rounded-lg p-3 text-sm h-24"/>
                                <button type="submit" className="bg-orange-600 hover:bg-orange-500 text-white font-bold py-3 rounded-lg text-sm shadow-lg shadow-orange-600/20 transition-all btn-gloss">Add Entry</button>
                            </form>
                            <div className="space-y-4 max-h-[600px] overflow-y-auto pr-2 custom-scroll">
                                {logs.filter(l => l.truckId === truck.id).sort((a,b) => new Date(b.date) - new Date(a.date)).map(log => (
                                    <div key={log.id} className="bg-white/5 p-4 rounded-xl border border-white/5 hover:bg-white/10 transition-colors">
                                        <div className="flex justify-between items-start mb-2"><div className="flex items-center gap-3"><span className="px-2 py-0.5 rounded bg-black/40 text-xs text-slate-300 font-mono border border-white/10">{log.date}</span><span className="text-xs font-bold text-orange-400 uppercase tracking-wide">{log.type}</span></div><button onClick={() => onDeleteLog(log.id)} className="text-slate-600 hover:text-red-400 transition-colors"><Icons.Trash2 className="w-4 h-4"/></button></div>
                                        <div className="text-slate-200 text-sm leading-relaxed">{log.notes}</div>
                                        {log.mechanic && <div className="text-xs text-slate-500 mt-2 flex items-center"><Icons.Wrench className="w-3 h-3 mr-1"/> {log.mechanic}</div>}
                                    </div>
                                ))}{logs.filter(l => l.truckId === truck.id).length === 0 && <div className="text-center text-slate-600 italic py-8">No maintenance history recorded.</div>}
                            </div>
                        </div>
                        <div className="space-y-8">
                             <div className="gloss-panel rounded-2xl p-6"><h3 className="text-xl font-bold text-white mb-4 flex items-center"><Icons.ClipboardCheck className="w-5 h-5 mr-3 text-emerald-500"/> Hoist History</h3><div className="space-y-2 max-h-64 overflow-y-auto pr-2 custom-scroll">{hoistChecks.filter(h => h.truckId === truck.id).sort((a,b) => b.month.localeCompare(a.month)).map(check => (<div key={check.id} className="flex justify-between items-center p-3 bg-slate-900/30 rounded-lg border border-white/5 shadow-sm"><div className="font-mono text-slate-400 text-sm">{check.month}</div><div className="flex items-center text-emerald-400 text-xs font-bold"><Icons.CheckCircle className="w-3 h-3 mr-1.5"/> {check.date}</div></div>))}{hoistChecks.filter(h => h.truckId === truck.id).length === 0 && <div className="text-center text-slate-600 italic text-sm py-4">No checks yet.</div>}</div></div>
                            <div className="gloss-panel rounded-2xl p-6"><h3 className="text-xl font-bold text-white mb-4">Current Notes</h3><div className="p-4 bg-slate-900/30 rounded-xl border border-white/5 text-slate-300 text-sm min-h-[100px] italic shadow-inner">{truck.notes || "No active notes for this vehicle."}</div></div>
                        </div>
                    </div>
                </div>
            );
        }

        const HoistCheckBoard = ({ trucks, hoistChecks, onCheck, onBack }) => {
            const [year, setYear] = useState(new Date().getFullYear());
            const months = Array.from({length: 12}, (_, i) => { const d = new Date(year, i, 1); return { num: String(i + 1).padStart(2, '0'), name: d.toLocaleString('default', { month: 'short' }) }; });
            const sortedTrucks = [...trucks].sort((a,b) => a.number.localeCompare(b.number, undefined, {numeric: true}));
            const handleCellClick = (truckId, monthStr) => { const isChecked = hoistChecks.some(h => h.truckId === truckId && h.month === monthStr); if(isChecked) return; if(window.confirm(`Confirm Hoist Alarm check for Truck in ${monthStr}?`)) { onCheck({ truckId, month: monthStr, date: getLocalDateString(new Date()) }); } };
            return (
                <div className="space-y-6 animate-fade-in w-full max-w-8xl mx-auto">
                    <div className="flex flex-col md:flex-row justify-between items-center gap-4"><button onClick={onBack} className="flex items-center text-slate-400 hover:text-white px-4 py-2 rounded-full bg-slate-800/50 hover:bg-slate-700 transition-all w-fit btn-gloss text-sm"><Icons.ChevronLeft className="w-4 h-4 mr-1"/> Back to Fleet</button><div className="flex items-center gap-4 bg-slate-900/50 p-2 rounded-full border border-white/10 shadow-inner"><button onClick={() => setYear(year-1)} className="p-2 hover:bg-white/10 rounded-full text-slate-400 hover:text-white transition-colors"><Icons.ChevronLeft className="w-5 h-5"/></button><h2 className="text-xl font-bold text-white w-24 text-center">{year}</h2><button onClick={() => setYear(year+1)} className="p-2 hover:bg-white/10 rounded-full text-slate-400 hover:text-white transition-colors"><Icons.ChevronRight className="w-5 h-5"/></button></div></div>
                    <div className="gloss-panel rounded-2xl overflow-hidden p-0 shadow-2xl"><div className="overflow-x-auto"><table className="w-full text-center border-collapse"><thead><tr className="bg-slate-900/80 text-slate-400 text-xs uppercase tracking-wider font-bold border-b border-white/10"><th className="sticky left-0 bg-slate-900/95 z-20 px-6 py-4 text-left border-r border-white/5 min-w-[120px] shadow-lg">Truck</th>{months.map(m => <th key={m.num} className="px-4 py-4 min-w-[60px]">{m.name}</th>)}</tr></thead><tbody className="divide-y divide-white/5 text-sm">{sortedTrucks.map(truck => (<tr key={truck.id} className="hover:bg-white/5 transition-colors"><td className="sticky left-0 bg-slate-900/90 z-10 px-6 py-3 text-left font-black text-white border-r border-white/5 shadow-lg">{truck.number}</td>{months.map(m => { const monthKey = `${year}-${m.num}`; const check = hoistChecks.find(h => h.truckId === truck.id && h.month === monthKey); return (<td key={monthKey} className="px-2 py-2"><button onClick={() => handleCellClick(truck.id, monthKey)} disabled={!!check} className={`w-8 h-8 rounded-lg flex items-center justify-center mx-auto transition-all shadow-md ${check ? 'bg-emerald-500 text-white shadow-emerald-500/30' : 'bg-red-900/20 text-red-500 border border-red-500/20 hover:bg-red-500 hover:text-white hover:border-red-500'}`} title={check ? `Checked on ${check.date}` : "Click to Check"}>{check ? <Icons.CheckCircle className="w-5 h-5"/> : <Icons.XCircle className="w-4 h-4 opacity-50"/>}</button></td>) })}</tr>))}</tbody></table></div></div>
                </div>
            );
        };

        const DriverProfile = ({ driver, trucks, exceptions, incidents, documents, dailyHours, driverJobs, onBack, onUpdateDriver, onArchiveDriver, onDeleteDriver, onAddException, onDeleteException, onAddIncident, onDeleteIncident, onUploadDocument, onDeleteDocument, onUpdateHours, onAddJob, onToggleJob, onDeleteJob }) => {
            const [newIncident, setNewIncident] = useState({ date: getLocalDateString(new Date()), type: 'Accident', notes: '' });
            const [exceptionDate, setExceptionDate] = useState('');
            const [exceptionType, setExceptionType] = useState('OUT');
            const [scheduleEdit, setScheduleEdit] = useState([...(driver.defaultSchedule || [])]);
            const fileInputRef = useRef(null);
            const [isUploading, setIsUploading] = useState(false);
            const [jobWeekStart, setJobWeekStart] = useState(() => getStartOfWeek(new Date()));
            const [addingJobDate, setAddingJobDate] = useState(null);
            const [newJobData, setNewJobData] = useState({ jobType: 'Delivery', containerType: '20yd', customerName: '', address: '' });
            const getWeekDates = (start) => { const week = []; for(let i=0; i<7; i++) { const nextDate = new Date(start); nextDate.setDate(start.getDate() + i); week.push(getLocalDateString(nextDate)); } return week; };
            const currentWeek = getWeekDates(getStartOfWeek(new Date())); const jobWeekDays = getWeekDates(jobWeekStart); const daysShort = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']; const standardDays = [{l: 'Sun', v: 0}, {l: 'Mon', v: 1}, {l: 'Tue', v: 2}, {l: 'Wed', v: 3}, {l: 'Thu', v: 4}, {l: 'Fri', v: 5}, {l: 'Sat', v: 6}];
            const getWeeklyTotal = () => { let total = 0; currentWeek.forEach(date => { const entry = dailyHours.find(h => h.driverId === driver.id && h.date === date); if(entry && entry.hours) total += parseFloat(entry.hours); }); return total.toFixed(1); };
            const toggleDay = (val) => { const newSched = scheduleEdit.includes(val) ? scheduleEdit.filter(d => d !== val) : [...scheduleEdit, val].sort(); setScheduleEdit(newSched); onUpdateDriver(driver.id, { defaultSchedule: newSched }); };
            const handleAddIncident = (e) => { e.preventDefault(); if (!newIncident.notes) return; onAddIncident({ ...newIncident, driverId: driver.id }); setNewIncident({ ...newIncident, notes: '' }); };
            const handleAddException = (e) => { e.preventDefault(); if(!exceptionDate) return; onAddException({ driverId: driver.id, date: exceptionDate, type: exceptionType }); setExceptionDate(''); };
            const handleQuickCallOut = () => { const today = getLocalDateString(new Date()); const exists = exceptions.find(e => e.driverId === driver.id && e.date === today); if(!exists) { onAddException({ driverId: driver.id, date: today, type: 'OUT' }); } };
            const handleFileChange = async (e) => { const file = e.target.files[0]; if (!file) return; setIsUploading(true); try { await onUploadDocument(driver.id, file); } finally { setIsUploading(false); e.target.value = ''; } };
            const changeJobWeek = (offset) => { const newDate = new Date(jobWeekStart); newDate.setDate(newDate.getDate() + (offset * 7)); setJobWeekStart(newDate); };
            const handleAddJobSubmit = (e) => { e.preventDefault(); if(addingJobDate) { onAddJob({ driverId: driver.id, date: addingJobDate, jobType: newJobData.jobType, containerType: newJobData.containerType, customerName: newJobData.customerName, address: newJobData.address, completed: false }); setAddingJobDate(null); setNewJobData({ jobType: 'Delivery', containerType: '20yd', customerName: '', address: '' }); } };
            const activeTrucks = trucks.filter(t => t.status !== 'Down');
            return (
                <div className="space-y-8 animate-fade-in max-w-7xl mx-auto relative z-20">
                    <input type="file" ref={fileInputRef} onChange={handleFileChange} className="hidden" />
                    <button onClick={onBack} className="flex items-center text-slate-400 hover:text-white mb-4 px-4 py-2 rounded-full bg-slate-800 hover:bg-slate-700 transition-all w-fit btn-gloss text-sm"><Icons.ChevronLeft className="w-4 h-4 mr-1"/> Back to List</button>
                    <div className="gloss-panel rounded-3xl p-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-8 shadow-2xl">
                        <div className="flex items-center gap-6">
                            <div className={`w-24 h-24 rounded-2xl flex items-center justify-center text-4xl shadow-2xl border border-white/20 ${driver.shift === 'Day' ? 'bg-gradient-to-br from-amber-700 to-amber-900 text-amber-100' : 'bg-gradient-to-br from-indigo-700 to-indigo-900 text-indigo-100'}`}>{driver.shift === 'Day' ? <Icons.Sun className="w-12 h-12 drop-shadow-md"/> : <Icons.Moon className="w-12 h-12 drop-shadow-md"/>}</div>
                            <div><h1 className="text-5xl font-black text-white tracking-tight drop-shadow-lg">{driver.name}</h1><div className="flex items-center gap-3 text-slate-400 mt-2">{driver.status === 'Archived' ? <span className="px-3 py-1 bg-red-900/50 text-red-300 rounded-full text-xs font-bold border border-red-500/30">ARCHIVED</span> : <span className="px-3 py-1 bg-emerald-900/50 text-emerald-300 rounded-full text-xs font-bold border border-emerald-500/30">ACTIVE</span>}<span className="px-3 py-1 bg-black/40 rounded-full text-xs uppercase font-bold tracking-wider border border-white/10 shadow-inner">{driver.shift} Shift</span><span className="px-3 py-1 bg-slate-800 rounded-full text-xs uppercase font-bold tracking-wider border border-white/10 shadow-inner">{driver.depot || 'Jersey City'}</span></div></div>
                        </div>
                        <div className="flex gap-4 items-center">{driver.status !== 'Archived' && <button onClick={handleQuickCallOut} className="px-5 py-3 bg-red-600 hover:bg-red-500 text-white font-bold rounded-xl shadow-lg shadow-red-900/40 flex items-center transition-all hover:scale-105 btn-gloss"><Icons.AlertTriangle className="w-5 h-5 mr-2"/> Mark Out Today</button>}{driver.status === 'Archived' ? (<button onClick={() => onUpdateDriver(driver.id, { status: 'Active', archivedDate: null })} className="px-5 py-3 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-xl shadow-lg btn-gloss">Reactivate Driver</button>) : (<button onClick={() => onArchiveDriver(driver.id)} className="px-5 py-3 bg-slate-700 hover:bg-slate-600 text-white font-bold rounded-xl shadow-lg btn-gloss border border-white/10">Archive Driver</button>)}</div>
                    </div>
                    <div className="gloss-panel rounded-2xl p-6 shadow-xl">
                        <div className="flex justify-between items-center mb-6"><h3 className="text-xl font-bold text-white flex items-center"><Icons.Clock className="w-5 h-5 mr-3 text-purple-400"/> Weekly Hours</h3><div className="text-xs text-slate-400 font-mono bg-black/30 px-3 py-1 rounded-full border border-white/10">Week of {new Date(currentWeek[0]).toLocaleDateString(undefined, {month:'short', day:'numeric'})}</div></div>
                        <div className="flex flex-col md:flex-row gap-4 items-center"><div className="flex-1 w-full grid grid-cols-7 gap-2">{currentWeek.map((dateStr, idx) => { const entry = dailyHours.find(h => h.driverId === driver.id && h.date === dateStr); const val = entry ? entry.hours : ''; const isToday = dateStr === getLocalDateString(new Date()); return (<div key={dateStr} className="flex flex-col gap-1"><label className={`text-[10px] text-center font-bold uppercase ${isToday ? 'text-purple-400' : 'text-slate-500'}`}>{daysShort[idx]}</label><input type="number" placeholder="-" className={`w-full text-center p-2 rounded-lg text-sm border focus:ring-2 focus:ring-purple-500 outline-none transition-all ${isToday ? 'bg-purple-900/20 border-purple-500/50 text-white' : 'bg-slate-900/50 border-white/10 text-slate-300'}`} value={val} onChange={(e) => onUpdateHours(driver.id, dateStr, e.target.value)}/></div>)})}</div><div className="w-full md:w-32 flex flex-col items-center justify-center p-4 bg-gradient-to-br from-purple-900/30 to-purple-950/30 rounded-xl border border-purple-500/30 shadow-inner"><span className="text-[10px] font-bold text-purple-300 uppercase tracking-widest mb-1">Total</span><span className="text-3xl font-black text-white drop-shadow-lg">{getWeeklyTotal()}</span><span className="text-[10px] text-purple-400/60">Hours</span></div></div>
                    </div>
                    <div className="gloss-panel rounded-2xl p-6 shadow-xl relative">
                        <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4"><h3 className="text-xl font-bold text-white flex items-center"><Icons.Box className="w-5 h-5 mr-3 text-cyan-400"/> Scheduled Jobs & Boxes</h3><div className="flex items-center gap-4 bg-black/20 p-1.5 rounded-full border border-white/10"><button onClick={() => changeJobWeek(-1)} className="p-1 hover:bg-white/10 rounded-full text-slate-400 hover:text-white transition-colors"><Icons.ChevronLeft className="w-5 h-5"/></button><span className="text-xs font-bold text-slate-300 w-32 text-center">Week of {jobWeekStart.toLocaleDateString(undefined, {month:'short', day:'numeric'})}</span><button onClick={() => changeJobWeek(1)} className="p-1 hover:bg-white/10 rounded-full text-slate-400 hover:text-white transition-colors"><Icons.ChevronRight className="w-5 h-5"/></button></div></div>
                        <div className="grid grid-cols-1 md:grid-cols-7 gap-3">{jobWeekDays.map((dateStr, idx) => { const dateObj = new Date(dateStr); dateObj.setMinutes(dateObj.getMinutes() + dateObj.getTimezoneOffset()); const isToday = dateStr === getLocalDateString(new Date()); const jobs = driverJobs.filter(j => j.driverId === driver.id && j.date === dateStr); return (<div key={dateStr} className={`rounded-xl border flex flex-col h-full min-h-[200px] bg-slate-900/40 ${isToday ? 'border-cyan-500/50 shadow-[0_0_10px_rgba(6,182,212,0.15)]' : 'border-white/5'}`}><div className={`p-2 text-center border-b ${isToday ? 'bg-cyan-900/20 border-cyan-500/20' : 'bg-white/5 border-white/5'}`}><div className="text-[10px] uppercase font-bold text-slate-500">{daysShort[idx]}</div><div className={`font-black text-lg ${isToday ? 'text-cyan-400' : 'text-slate-300'}`}>{parseInt(dateStr.split('-')[2])}</div></div><div className="p-2 flex-1 space-y-2 overflow-y-auto max-h-[300px] custom-scroll">{jobs.map(job => (<div key={job.id} className={`p-2 rounded border text-xs group relative ${job.completed ? 'bg-green-900/20 border-green-500/30 opacity-75' : 'bg-slate-800 border-white/10 hover:border-cyan-500/30'}`}><div className="flex justify-between items-start"><div className={`font-bold truncate ${job.completed ? 'text-slate-500 line-through' : 'text-white'}`}>{job.customerName || 'Unknown'}</div><button onClick={() => onDeleteJob(job.id)} className="text-slate-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity"><Icons.XCircle className="w-3 h-3"/></button></div><div className="text-[9px] text-slate-400 truncate mb-1">{job.address || 'No Address'}</div><div className={`text-[10px] font-bold ${job.completed ? 'text-slate-600' : 'text-cyan-300'}`}>{job.jobType}  {job.containerType}</div><button onClick={() => onToggleJob(job.id, !job.completed)} className={`mt-2 w-full py-1 rounded text-[9px] font-bold uppercase transition-colors ${job.completed ? 'bg-slate-800 text-slate-500' : 'bg-cyan-900/40 text-cyan-300 hover:bg-cyan-900/60 border border-cyan-500/20'}`}>{job.completed ? 'Completed' : 'Mark Done'}</button></div>))}<button onClick={() => setAddingJobDate(dateStr)} className="w-full py-2 rounded border border-dashed border-slate-700 text-slate-500 hover:text-cyan-400 hover:border-cyan-500/30 hover:bg-cyan-500/5 transition-all text-xs flex justify-center items-center"><Icons.Plus className="w-3 h-3"/></button></div></div>); })}</div>
                        {addingJobDate && (<div className="absolute inset-0 z-50 bg-slate-950/80 backdrop-blur-sm flex items-center justify-center rounded-2xl animate-fade-in p-4" onClick={() => setAddingJobDate(null)}><div className="bg-slate-900 border border-white/10 p-6 rounded-2xl shadow-2xl w-full max-w-sm" onClick={e => e.stopPropagation()}><h3 className="text-lg font-bold text-white mb-4">Add Job for {addingJobDate}</h3><form onSubmit={handleAddJobSubmit} className="space-y-3"><input type="text" placeholder="Customer Name" className="w-full input-gloss rounded-lg p-3 text-sm" value={newJobData.customerName} onChange={e => setNewJobData({...newJobData, customerName: e.target.value})} required /><input type="text" placeholder="Service Address" className="w-full input-gloss rounded-lg p-3 text-sm" value={newJobData.address} onChange={e => setNewJobData({...newJobData, address: e.target.value})} /><div className="grid grid-cols-2 gap-3"><div><label className="text-xs text-slate-400 uppercase font-bold block mb-1">Job Type</label><select className="w-full input-gloss rounded-lg p-3 text-sm" value={newJobData.jobType} onChange={e => setNewJobData({...newJobData, jobType: e.target.value})}><option>Delivery</option><option>Removal</option><option>Switch</option><option>Misc</option></select></div><div><label className="text-xs text-slate-400 uppercase font-bold block mb-1">Container</label><select className="w-full input-gloss rounded-lg p-3 text-sm" value={newJobData.containerType} onChange={e => setNewJobData({...newJobData, containerType: e.target.value})}><option>10yd</option><option>20yd</option><option>30yd</option><option>Breakaway</option><option>Compactor</option></select></div></div><div className="flex gap-3 pt-2"><button type="button" onClick={() => setAddingJobDate(null)} className="flex-1 py-3 rounded-lg bg-slate-800 text-slate-300 font-bold text-sm hover:bg-slate-700">Cancel</button><button type="submit" className="flex-1 py-3 rounded-lg bg-cyan-600 text-white font-bold text-sm hover:bg-cyan-500 shadow-lg shadow-cyan-900/20">Add Job</button></div></form></div></div>)}
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div className="space-y-8">
                            <div className="gloss-panel rounded-2xl p-6"><h3 className="text-xl font-bold text-white mb-6 flex items-center"><Icons.Wrench className="w-5 h-5 mr-3 text-blue-400"/> Settings</h3><div className="space-y-5"><div><label className="text-xs text-blue-300 uppercase font-bold tracking-wider mb-2 block">Preferred Truck</label><select className="w-full input-gloss rounded-lg p-3" value={driver.defaultTruckId || ""} onChange={(e) => onUpdateDriver(driver.id, { defaultTruckId: e.target.value })}><option value="">No Regular Truck</option>{activeTrucks.map(t => <option key={t.id} value={t.id}>{t.number} ({t.status})</option>)}</select></div><div className="grid grid-cols-2 gap-4"><div><label className="text-xs text-slate-400 uppercase font-bold tracking-wider mb-2 block">Shift</label><select className="w-full input-gloss rounded-lg p-3" value={driver.shift || "Day"} onChange={(e) => onUpdateDriver(driver.id, { shift: e.target.value })}><option value="Day">Day Shift</option><option value="Night">Night Shift</option></select></div><div><label className="text-xs text-slate-400 uppercase font-bold tracking-wider mb-2 block">Start Time</label><input type="time" className="w-full input-gloss rounded-lg p-3" value={driver.startTime || ""} onChange={(e) => onUpdateDriver(driver.id, { startTime: e.target.value })}/></div></div><div><label className="text-xs text-slate-400 uppercase font-bold tracking-wider mb-2 block">Start Date</label><input type="date" className="w-full input-gloss rounded-lg p-3 text-sm" value={driver.startDate || ""} onChange={(e) => onUpdateDriver(driver.id, { startDate: e.target.value })}/></div>
                            <div><label className="text-xs text-blue-300 font-bold uppercase tracking-wide mb-1 block">Depot Location</label><select className="w-full input-gloss rounded-lg p-3 text-sm" value={driver.depot || 'Jersey City'} onChange={(e) => onUpdateDriver(driver.id, { depot: e.target.value })}>{DEPOTS.map(d => <option key={d} value={d}>{d}</option>)}</select></div></div></div>
                            <div className="gloss-panel rounded-2xl p-6"><h3 className="text-xl font-bold text-white mb-6 flex items-center"><Icons.Calendar className="w-5 h-5 mr-3 text-green-400"/> Standard Schedule</h3><div className="flex justify-between gap-2">{standardDays.map((d) => (<button key={d.l} onClick={() => toggleDay(d.v)} className={`flex-1 py-3 rounded-lg text-xs font-bold transition-all shadow-lg btn-gloss ${scheduleEdit.includes(d.v) ? 'bg-green-600 text-white shadow-green-900/30' : 'bg-slate-800 text-slate-500 hover:bg-slate-700'}`}>{d.l}</button>))}</div></div>
                            <div className="gloss-panel rounded-2xl p-6"><h3 className="text-xl font-bold text-white mb-6 flex items-center"><Icons.AlertTriangle className="w-5 h-5 mr-3 text-yellow-500"/> Incident Log</h3><form onSubmit={handleAddIncident} className="flex flex-col gap-3 mb-6 bg-slate-900/30 p-4 rounded-xl border border-white/5 shadow-inner"><div className="flex gap-3"><input type="date" value={newIncident.date} onChange={e => setNewIncident({...newIncident, date: e.target.value})} className="input-gloss rounded-lg p-2 text-sm"/><select value={newIncident.type} onChange={e => setNewIncident({...newIncident, type: e.target.value})} className="input-gloss rounded-lg p-2 text-sm flex-1"><option>Accident</option><option>Ticket</option><option>Complaint</option><option>Other</option></select></div><input type="text" placeholder="Incident details..." value={newIncident.notes} onChange={e => setNewIncident({...newIncident, notes: e.target.value})} className="input-gloss rounded-lg p-2 text-sm"/><button type="submit" className="bg-yellow-600 hover:bg-yellow-500 text-black font-bold py-2 rounded-lg text-sm shadow-lg shadow-yellow-600/20 btn-gloss">Log Incident</button></form><div className="space-y-3 max-h-48 overflow-y-auto custom-scroll pr-2">{incidents.filter(i => i.driverId === driver.id).map(inc => (<div key={inc.id} className="bg-white/5 p-3 rounded-lg border border-white/5 flex justify-between items-start"><div><div className="text-xs text-yellow-500 font-bold uppercase tracking-wide">{inc.type}  {inc.date}</div><div className="text-sm text-slate-300 mt-1">{inc.notes}</div></div><button onClick={() => onDeleteIncident(inc.id)} className="text-slate-600 hover:text-red-500"><Icons.XCircle className="w-4 h-4"/></button></div>))}</div></div>
                        </div>
                        <div className="flex flex-col gap-8 h-full">
                             <div className="gloss-panel rounded-2xl p-6 flex-1"><h3 className="text-xl font-bold text-white mb-6 flex items-center"><Icons.FileText className="w-5 h-5 mr-3 text-cyan-300"/> Documents</h3><button onClick={() => { fileInputRef.current.click(); }} disabled={isUploading} className="w-full bg-cyan-700 hover:bg-cyan-600 text-white font-bold py-3 rounded-xl text-sm flex items-center justify-center gap-2 border border-white/20 shadow-lg btn-gloss transition-all mb-4">{isUploading ? <Icons.Spinner className="w-4 h-4"/> : <Icons.Upload className="w-4 h-4"/>} {isUploading ? "Uploading..." : "Upload Document"}</button><div className="space-y-3 max-h-[300px] overflow-y-auto custom-scroll">{documents.filter(d => d.driverId === driver.id).sort((a,b) => b.uploadedAt?.seconds - a.uploadedAt?.seconds).map(doc => (<div key={doc.id} className="flex items-center justify-between p-3 bg-slate-900/40 border border-white/5 rounded-lg hover:bg-slate-800/50 transition-colors shadow-sm"><div className="flex items-center gap-3 overflow-hidden"><div className="bg-cyan-900/30 p-2 rounded text-cyan-400 border border-cyan-500/20"><Icons.FileText className="w-4 h-4 flex-shrink-0"/></div><a href={doc.url} target="_blank" className="text-sm text-cyan-200 hover:text-white hover:underline truncate">{doc.name}</a></div><button onClick={() => onDeleteDocument(doc.id)} className="text-slate-600 hover:text-red-500"><Icons.Trash2 className="w-4 h-4"/></button></div>))}{documents.filter(d => d.driverId === driver.id).length === 0 && <div className="text-center text-slate-600 italic mt-4">No documents saved.</div>}</div></div>
                            <div className="gloss-panel rounded-2xl p-6 flex-1"><h3 className="text-xl font-bold text-white mb-6 flex items-center"><Icons.Plane className="w-5 h-5 mr-3 text-teal-400"/> Time Off & Exceptions</h3><form onSubmit={handleAddException} className="bg-slate-900/30 p-4 rounded-xl mb-4 border border-white/5 shadow-inner"><div className="flex gap-2 mb-3"><input type="date" className="input-gloss rounded-lg p-2 w-full text-sm" value={exceptionDate} onChange={e => setExceptionDate(e.target.value)} /><select className="input-gloss rounded-lg p-2 text-sm" value={exceptionType} onChange={e => setExceptionType(e.target.value)}><option value="OUT">Call Out</option><option value="VACATION">Vacation</option><option value="OFF">Off Day</option><option value="EXTRA">Extra Shift</option></select></div><button type="submit" className="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 rounded-lg text-sm transition-colors btn-gloss">Add Exception</button></form><div className="space-y-2 max-h-[300px] overflow-y-auto custom-scroll">{exceptions.filter(e => e.driverId === driver.id).sort((a,b) => new Date(b.date) - new Date(a.date)).map(ex => (<div key={ex.id} className="flex items-center justify-between p-3 bg-slate-800/40 border border-white/5 rounded-lg"><div className="flex items-center gap-3"><div className={`w-1.5 h-8 rounded-full ${ex.type === 'OUT' ? 'bg-red-500' : ex.type === 'VACATION' ? 'bg-teal-500' : 'bg-slate-500'}`}></div><div><div className="font-mono text-white font-bold text-sm">{ex.date}</div><div className={`text-[10px] font-bold tracking-wider ${ex.type === 'OUT' ? 'text-red-400' : ex.type === 'VACATION' ? 'text-teal-400' : ex.type === 'EXTRA' ? 'text-purple-400' : 'text-slate-400'}`}>{ex.type === 'OUT' ? 'CALLED OUT' : ex.type === 'VACATION' ? 'VACATION' : ex.type === 'EXTRA' ? 'EXTRA SHIFT' : 'OFF'}</div></div></div><button onClick={() => onDeleteException(ex.id)} className="text-slate-600 hover:text-white transition-colors"><Icons.Trash2 className="w-4 h-4"/></button></div>))}</div></div>
                        </div>
                    </div>
                    <div className="flex justify-center mt-8 border-t border-white/10 pt-4"><button onClick={() => onDeleteDriver(driver.id)} className="text-red-900/50 hover:text-red-500 text-xs font-bold uppercase tracking-widest flex items-center transition-colors"><Icons.Trash2 className="w-4 h-4 mr-2"/> Permanently Delete Database Record</button></div>
                </div>
            );
        };

        const TaskBoard = ({ tasks, onAddTask, onToggleTask, onDeleteTask }) => {
            const [newTask, setNewTask] = useState("");
            const handleAdd = (e) => { e.preventDefault(); if(!newTask.trim()) return; onAddTask(newTask); setNewTask(""); }; 
            return (
                <div className="max-w-4xl mx-auto space-y-8 animate-fade-in">
                    <div className="flex justify-between items-center"><h2 className="text-2xl font-bold text-white flex items-center gap-3"><Icons.ListTodo className="text-purple-400 w-8 h-8 drop-shadow-md"/> Operational Tasks</h2></div>
                    <form onSubmit={handleAdd} className="relative group"><div className="absolute -inset-1 bg-gradient-to-r from-purple-600 to-indigo-600 rounded-2xl opacity-40 group-hover:opacity-60 transition duration-500 blur-md"></div><div className="relative flex gap-2 gloss-panel rounded-2xl p-2"><input type="text" value={newTask} onChange={(e) => setNewTask(e.target.value)} placeholder="What needs to be done?" className="flex-1 bg-transparent border-none text-white px-4 focus:ring-0 outline-none placeholder-slate-500 text-lg" /><button type="submit" className="px-6 py-2 bg-purple-600 text-white rounded-xl font-bold hover:bg-purple-500 transition-colors shadow-lg btn-gloss">Add Task</button></div></form>
                    <div className="gloss-panel rounded-2xl overflow-hidden">{tasks.length === 0 && <div className="p-12 text-center text-slate-500 flex flex-col items-center"><Icons.CheckSquare className="w-16 h-16 mb-4 opacity-10"/>No active tasks. Good job!</div>}<ul className="divide-y divide-white/5">{tasks.map(task => (<li key={task.id} className={`flex items-center justify-between p-5 hover:bg-white/5 transition-colors group ${task.completed ? 'bg-black/20' : ''}`}><div className="flex items-center gap-4 cursor-pointer flex-1" onClick={() => onToggleTask(task)}><div className={`rounded-lg p-1 transition-colors ${task.completed ? 'text-emerald-500' : 'text-slate-600 group-hover:text-purple-400'}`}>{task.completed ? <Icons.CheckSquare className="w-6 h-6" /> : <Icons.Square className="w-6 h-6" />}</div><span className={`text-lg font-medium transition-all ${task.completed ? 'line-through text-slate-500 decoration-slate-600' : 'text-slate-200'}`}>{task.text}</span></div><button onClick={() => onDeleteTask(task.id)} className="text-slate-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-all p-2"><Icons.Trash2 className="w-5 h-5" /></button></li>))}</ul></div>
                </div>
            );
        };
        const WeeklyCalendar = ({ drivers, exceptions, routes, onUpdateDriverSchedule }) => { const [currentWeekStart, setCurrentWeekStart] = useState(() => getStartOfWeek(new Date())); const [showMasterRoster, setShowMasterRoster] = useState(false); const changeWeek = (offset) => { const newDate = new Date(currentWeekStart); newDate.setDate(newDate.getDate() + (offset * 7)); setCurrentWeekStart(newDate); }; const weekDates = Array.from({ length: 7 }).map((_, i) => { const d = new Date(currentWeekStart); d.setDate(d.getDate() + i); return d; }); const activeDrivers = drivers.filter(d => d.status !== 'Archived'); const getScheduleForDate = (dateObj) => { const dateStr = getLocalDateString(dateObj); const dayOfWeek = dateObj.getDay(); const dayCrew = [], nightCrew = [], offCrew = []; drivers.forEach(driver => { if (driver.startDate && dateStr < driver.startDate) return; if (driver.status === 'Archived' && driver.archivedDate && dateStr > driver.archivedDate) return; if (driver.status === 'Archived' && !driver.archivedDate && dateObj > new Date()) return; const exception = exceptions.find(e => e.driverId === driver.id && e.date === dateStr); const isDefaultWorking = driver.defaultSchedule && driver.defaultSchedule.includes(dayOfWeek); let status = 'OFF', type = 'REGULAR'; if (exception) { if (exception.type === 'WORKING' || exception.type === 'EXTRA') status = 'WORKING'; else { status = 'OFF'; type = exception.type; } } else { if (isDefaultWorking) status = 'WORKING'; else { status = 'OFF'; type = 'OFF'; } } if (status === 'WORKING') { const shift = driver.shift || 'Day'; if (shift === 'Night') nightCrew.push(driver); else dayCrew.push(driver); } else { offCrew.push({ ...driver, type }); } }); return { dayCrew, nightCrew, offCrew }; }; return (<div className="space-y-8 animate-fade-in"><div className="flex flex-col md:flex-row justify-between items-center gloss-panel p-4 rounded-2xl gap-4"><div className="flex items-center gap-4"><button onClick={() => changeWeek(-1)} className="p-2 hover:bg-white/10 rounded-full text-slate-400 hover:text-white transition-colors"><Icons.ChevronLeft className="w-6 h-6"/></button><h2 className="text-xl font-bold text-white flex items-center gap-3 bg-slate-900/50 px-6 py-2 rounded-full border border-white/10 shadow-inner"><Icons.CalendarDays className="w-5 h-5 text-orange-400"/> Week of {currentWeekStart.toLocaleDateString(undefined, {month:'short', day:'numeric'})}</h2><button onClick={() => changeWeek(1)} className="p-2 hover:bg-white/10 rounded-full text-slate-400 hover:text-white transition-colors"><Icons.ChevronRight className="w-6 h-6"/></button></div><button onClick={() => setShowMasterRoster(!showMasterRoster)} className={`text-sm px-5 py-2 rounded-full border transition-all btn-gloss ${showMasterRoster ? 'bg-blue-600 text-white' : 'bg-slate-700 text-slate-300'}`}>{showMasterRoster ? "Hide Master Roster" : "Edit Master Roster"}</button></div>{showMasterRoster && (<div className="gloss-panel rounded-2xl p-8 animate-fade-in mb-8"><h3 className="text-lg font-bold text-white mb-6">Master Roster (Recurring)</h3><div className="overflow-x-auto"><table className="w-full text-left text-sm"><thead className="text-slate-500 border-b border-white/5"><tr><th className="py-3 font-bold uppercase tracking-wider text-xs">Driver</th>{['S','M','T','W','T','F','S'].map((d,i) => <th key={i} className="py-3 text-center font-bold">{d}</th>)}</tr></thead><tbody className="divide-y divide-white/5">{activeDrivers.map(driver => (<tr key={driver.id} className="hover:bg-white/5 transition-colors"><td className="py-3 text-white font-medium pl-2">{driver.name}</td>{[0,1,2,3,4,5,6].map(idx => { const isActive = driver.defaultSchedule && driver.defaultSchedule.includes(idx); return (<td key={idx} className="text-center"><button onClick={() => { const current = driver.defaultSchedule || []; const newSched = current.includes(idx) ? current.filter(d => d !== idx) : [...current, idx].sort(); onUpdateDriverSchedule(driver.id, newSched); }} className={`w-8 h-8 rounded-lg flex items-center justify-center mx-auto transition-all ${isActive ? 'bg-blue-600 text-white shadow-lg shadow-blue-600/30 btn-gloss' : 'bg-slate-800 text-slate-700 shadow-inner'}`}>{isActive && <Icons.CheckCircle className="w-4 h-4"/>}</button></td>)})}</tr>))}</tbody></table></div></div>)}<div className="grid grid-cols-1 md:grid-cols-7 gap-4">{weekDates.map((date, idx) => { const { dayCrew, nightCrew, offCrew } = getScheduleForDate(date); const isToday = getLocalDateString(date) === getLocalDateString(new Date()); return (<div key={idx} className={`gloss-card rounded-xl flex flex-col h-full min-h-[350px] overflow-hidden border ${isToday ? 'border-blue-500/50 ring-1 ring-blue-500/30' : 'border-white/5'}`}><div className={`p-3 border-b ${isToday ? 'bg-blue-900/40 border-blue-500/30' : 'bg-white/5 border-white/5'} text-center backdrop-blur-md`}><div className="text-[10px] uppercase font-black tracking-widest text-slate-500">{date.toLocaleDateString(undefined, {weekday:'short'})}</div><div className={`text-2xl font-black ${isToday ? 'text-blue-400 drop-shadow-md' : 'text-white'}`}>{date.getDate()}</div></div><div className="p-3 flex-1 flex flex-col gap-3 text-sm"><div className="bg-amber-900/10 rounded-lg p-2 border border-amber-500/10"><div className="text-[10px] uppercase font-bold text-amber-500 mb-1 flex items-center opacity-80"><Icons.Sun className="w-3 h-3 mr-1"/> Day Crew</div>{dayCrew.length > 0 ? (<ul className="space-y-1.5">{dayCrew.map(d => { const route = routes.find(r => r.driverId === d.id); return (<li key={d.id} className="text-slate-300 truncate font-medium text-xs pl-1 border-l-2 border-amber-500/30">{route && <span className="font-mono font-black text-blue-400 mr-1.5">{route.routeNumber}</span>}{d.name}</li>) })}</ul>) : <div className="text-slate-700 text-xs italic text-center py-2">Empty</div>}</div><div className="bg-indigo-900/10 rounded-lg p-2 border border-indigo-500/10"><div className="text-[10px] uppercase font-bold text-indigo-400 mb-1 flex items-center opacity-80"><Icons.Moon className="w-3 h-3 mr-1"/> Night Crew</div>{nightCrew.length > 0 ? (<ul className="space-y-1.5">{nightCrew.map(d => { const route = routes.find(r => r.driverId === d.id); return (<li key={d.id} className="text-slate-300 truncate font-medium text-xs pl-1 border-l-2 border-indigo-500/30">{route && <span className="font-mono font-black text-blue-400 mr-1.5">{route.routeNumber}</span>}{d.name}</li>) })}</ul>) : <div className="text-slate-700 text-xs italic text-center py-2">Empty</div>}</div><div className="mt-auto pt-3 border-t border-white/5"><div className="text-[10px] uppercase font-bold text-slate-600 mb-1 tracking-widest">Off / Out</div><ul className="space-y-1">{offCrew.map(d => (<li key={d.id} className="flex justify-between items-center text-[11px]"><span className="text-slate-500 truncate max-w-[60%]">{d.name}</span>{d.type === 'VACATION' && <span className="bg-teal-500/20 text-teal-400 px-1.5 py-0.5 rounded-[3px] font-bold text-[9px]">VAC</span>}{d.type === 'OUT' && <span className="bg-red-500/20 text-red-400 px-1.5 py-0.5 rounded-[3px] font-bold text-[9px]">OUT</span>}</li>))}</ul></div></div></div>); })}</div></div>);};
        const GeneralDocsBoard = ({ documents, onUploadDocument, onDeleteDocument }) => {const fileInputRef = useRef(null);const [isUploading, setIsUploading] = useState(false);const handleFileChange = async (e) => { const file = e.target.files[0]; if (!file) return; setIsUploading(true); try { await onUploadDocument(file); } finally { setIsUploading(false); e.target.value = ''; } }; return (<div className="max-w-4xl mx-auto space-y-8 animate-fade-in"><div className="flex flex-col"><h2 className="text-2xl font-bold text-white flex items-center gap-3"><Icons.FileText className="text-blue-400 w-8 h-8 drop-shadow-md"/> General Documents</h2><div className="text-sm text-slate-400 ml-11">Forms, Contacts, & Procedures</div></div><div className="gloss-panel rounded-2xl p-8"><div className="mb-8"><input type="file" ref={fileInputRef} onChange={handleFileChange} className="hidden" /><button onClick={() => fileInputRef.current.click()} disabled={isUploading} className="w-full border-2 border-dashed border-slate-700 hover:border-blue-500/50 hover:bg-blue-500/5 rounded-2xl p-12 flex flex-col items-center justify-center text-slate-400 hover:text-blue-400 transition-all group cursor-pointer">{isUploading ? <Icons.Spinner className="w-10 h-10 mb-4 text-blue-500"/> : <Icons.Upload className="w-10 h-10 mb-4 group-hover:scale-110 transition-transform group-hover:text-blue-400"/>}<span className="font-bold text-xl">{isUploading ? "Uploading to Vault..." : "Upload Document"}</span><span className="text-xs mt-2 text-slate-600 font-medium uppercase tracking-wider">PDFs, Images, Word Docs Supported</span></button></div><div className="space-y-4"><h3 className="text-xs font-bold text-slate-500 uppercase mb-4 pl-1 tracking-widest">File Archive</h3><div className="grid gap-4">{documents.sort((a,b) => b.uploadedAt?.seconds - a.uploadedAt?.seconds).map(doc => (<div key={doc.id} className="flex items-center justify-between p-4 bg-slate-900/40 border border-white/5 rounded-xl hover:bg-slate-800/60 hover:border-white/10 transition-all group shadow-md"><div className="flex items-center gap-5 overflow-hidden"><div className="bg-gradient-to-br from-blue-900 to-blue-950 p-3 rounded-lg text-blue-400 shadow-inner border border-blue-500/20"><Icons.FileText className="w-6 h-6"/></div><div className="flex flex-col overflow-hidden"><a href={doc.url} target="_blank" className="text-white font-bold text-lg hover:text-blue-400 hover:underline truncate transition-colors">{doc.name}</a><span className="text-xs text-slate-500 font-mono mt-1">Uploaded {doc.uploadedAt ? new Date(doc.uploadedAt.seconds * 1000).toLocaleDateString() : 'Just now'}</span></div></div><button onClick={() => onDeleteDocument(doc.id)} className="text-slate-600 hover:text-red-500 p-3 opacity-0 group-hover:opacity-100 transition-all bg-slate-900 rounded-lg hover:bg-red-900/20"><Icons.Trash2 className="w-5 h-5"/></button></div>))}{documents.length === 0 && (<div className="text-center py-12 text-slate-600 italic border border-dashed border-slate-800 rounded-2xl">The vault is empty.</div>)}</div></div></div></div>);};
        
        const CompactorBoard = ({ customers, issues, onAddCustomer, onDeleteCustomer, onViewCustomer, onArchiveCustomer, onRestoreCustomer }) => {
            const [newName, setNewName] = useState(''); const [newAddr, setNewAddr] = useState(''); const [showArchived, setShowArchived] = useState(false);
            const handleAdd = (e) => { e.preventDefault(); if(!newName.trim()) return; onAddCustomer({ name: newName, address: newAddr }); setNewName(''); setNewAddr(''); };
            const filteredCustomers = customers.filter(c => showArchived ? c.status === 'Archived' : c.status !== 'Archived');
            const sortedCustomers = [...filteredCustomers].sort((a, b) => a.name.localeCompare(b.name));
            return (
                <div className="max-w-6xl mx-auto space-y-8 animate-fade-in">
                    <div className="flex justify-between items-center"><h2 className="text-2xl font-bold text-white flex items-center gap-3"><Icons.Archive className="text-orange-500 w-8 h-8 drop-shadow-md"/> Compactor Clients</h2><label className="flex items-center cursor-pointer text-xs text-slate-400 hover:text-white transition-colors bg-slate-900/50 px-4 py-2 rounded-full border border-white/10"><input type="checkbox" checked={showArchived} onChange={() => setShowArchived(!showArchived)} className="mr-2" /> Show Archived Jobs</label></div>
                    {!showArchived && (<form onSubmit={handleAdd} className="gloss-panel p-6 rounded-2xl flex flex-col md:flex-row gap-4 items-end"><div className="flex-1 w-full"><label className="text-xs text-slate-400 uppercase font-bold mb-1 block ml-1">Client Name</label><input type="text" placeholder="Enter name..." className="w-full input-gloss rounded-lg px-4 py-3" value={newName} onChange={e => setNewName(e.target.value)} /></div><div className="flex-1 w-full"><label className="text-xs text-slate-400 uppercase font-bold mb-1 block ml-1">Location</label><input type="text" placeholder="Enter address..." className="w-full input-gloss rounded-lg px-4 py-3" value={newAddr} onChange={e => setNewAddr(e.target.value)} /></div><button type="submit" className="px-8 py-3 bg-orange-600 text-white rounded-lg font-bold hover:bg-orange-500 transition-all shadow-lg shadow-orange-900/20 btn-gloss">Add Client</button></form>)}
                    <div className="gloss-panel rounded-2xl overflow-hidden"><table className="w-full text-left"><thead className="bg-slate-900/50 text-slate-400 text-xs uppercase tracking-wider font-bold"><tr><th className="px-6 py-4">Name</th><th className="px-6 py-4">Status</th><th className="px-6 py-4 text-right">Actions</th></tr></thead><tbody className="divide-y divide-white/5">{sortedCustomers.map(cust => { const issueCount = issues.filter(i => i.customerId === cust.id && i.status !== 'Resolved').length; return (<tr key={cust.id} className={`hover:bg-white/5 transition-colors cursor-pointer group ${cust.status === 'Archived' ? 'opacity-50 grayscale' : ''}`} onClick={() => onViewCustomer(cust.id)}><td className="px-6 py-4"><div className="font-bold text-white text-lg">{cust.name}</div><div className="text-xs text-slate-500">{cust.address}</div></td><td className="px-6 py-4">{cust.status === 'Archived' ? (<span className="bg-slate-700 text-slate-300 border border-white/10 px-3 py-1 rounded-full text-xs font-bold">ARCHIVED</span>) : issueCount > 0 ? (<span className="bg-red-500 text-white border border-white/20 px-3 py-1 rounded-full text-xs font-bold shadow-lg shadow-red-500/20 animate-pulse btn-gloss">{issueCount} Issues Active</span>) : (<span className="text-emerald-400 text-xs font-bold px-3 py-1 border border-emerald-500/20 rounded-full bg-emerald-900/20">System Healthy</span>)}</td><td className="px-6 py-4 text-right">{cust.status === 'Archived' ? (<button onClick={(e) => { e.stopPropagation(); onRestoreCustomer(cust.id); }} title="Restore to Active" className="text-slate-500 hover:text-emerald-400 p-2 opacity-0 group-hover:opacity-100 transition-all mr-2"><Icons.History className="w-5 h-5"/></button>) : (<button onClick={(e) => { e.stopPropagation(); onArchiveCustomer(cust.id); }} title="Archive Job" className="text-slate-500 hover:text-orange-400 p-2 opacity-0 group-hover:opacity-100 transition-all mr-2"><Icons.Archive className="w-5 h-5"/></button>)}<button onClick={(e) => { e.stopPropagation(); onDeleteCustomer(cust.id); }} title="Permanently Delete" className="text-slate-600 hover:text-red-500 p-2 opacity-0 group-hover:opacity-100 transition-all"><Icons.Trash2 className="w-5 h-5"/></button></td></tr>); })}{sortedCustomers.length === 0 && <tr><td colSpan={3} className="px-6 py-12 text-center text-slate-500">No {showArchived ? 'archived' : 'active'} customers found.</td></tr>}</tbody></table></div>
                </div>
            );
        };
        
        const RouteBoard = ({ drivers, routes, onUpdateRoute, onDeleteRoute, currentDepot }) => {
            const [selectedSlot, setSelectedSlot] = useState(null);
            const [isAdding, setIsAdding] = useState(false);
            const [newRouteNum, setNewRouteNum] = useState("");
            const depotRoutes = routes.filter(r => (r.depot || 'Jersey City') === currentDepot);
            const baseSlots = currentDepot === 'Jersey City' ? Array.from({ length: 25 }, (_, i) => i + 101) : [];
            const dbSlots = depotRoutes.map(r => parseInt(r.routeNumber)).filter(n => !isNaN(n));
            const allSlots = [...new Set([...baseSlots, ...dbSlots])].sort((a,b) => a - b);
            const activeDrivers = drivers.filter(d => d.status !== 'Archived');
            const handleAssign = (driverId) => { if (!selectedSlot) return; const existing = depotRoutes.find(r => r.routeNumber === selectedSlot); if (existing) { onUpdateRoute(existing.id, { driverId }); } else { onUpdateRoute(null, { routeNumber: selectedSlot, driverId, depot: currentDepot }); } setSelectedSlot(null); };
            const handleAddRouteSubmit = (e) => { e.preventDefault(); const num = parseInt(newRouteNum); if (num) { const existing = depotRoutes.find(r => r.routeNumber === num); if (!existing) { onUpdateRoute(null, { routeNumber: num, driverId: null, depot: currentDepot }); } } setIsAdding(false); setNewRouteNum(""); };
            const handleClear = (e, route) => { e.stopPropagation(); if(route) onDeleteRoute(route.id); }; 
            return (
                <div className="max-w-7xl mx-auto space-y-8 animate-fade-in">
                    <div className="flex justify-between items-center"><h2 className="text-2xl font-bold text-white flex items-center gap-3"><Icons.Map className="text-blue-400 w-8 h-8 drop-shadow-md"/> Route Assignments ({currentDepot})</h2><button onClick={() => setIsAdding(true)} className="flex items-center gap-2 px-6 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-full font-bold transition-all shadow-lg shadow-blue-900/40 btn-gloss"><Icons.Plus className="w-5 h-5" /> Add Route</button></div>
                    <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">{allSlots.length > 0 ? allSlots.map(num => { const route = depotRoutes.find(r => r.routeNumber === num); const driver = route && drivers.find(d => d.id === route.driverId); const isAssigned = !!driver; return (<div key={num} onClick={() => setSelectedSlot(num)} className={`relative p-4 rounded-2xl border cursor-pointer transition-all duration-300 hover:scale-105 flex flex-col items-center justify-center h-36 text-center group ${isAssigned ? 'gloss-panel bg-blue-900/30 border-blue-500/40 shadow-[0_0_25px_rgba(59,130,246,0.2)]' : 'gloss-card hover:bg-slate-800/50'}`}><div className={`text-3xl font-black mb-2 ${isAssigned ? 'text-blue-400 drop-shadow-lg' : 'text-slate-600'}`}>{num}</div>{isAssigned ? (<><div className="font-bold text-white truncate w-full px-2 text-sm bg-black/40 py-1 rounded-full backdrop-blur-md border border-white/5">{driver.name}</div>{driver.shift === 'Night' && <div className="absolute top-2 left-2 text-indigo-400"><Icons.Moon className="w-4 h-4"/></div>}<button onClick={(e) => handleClear(e, route)} className="absolute top-2 right-2 text-slate-400 hover:text-red-400 p-1 opacity-0 group-hover:opacity-100 transition-all"><Icons.XCircle className="w-5 h-5"/></button></>) : (<div className="text-[10px] text-slate-700 uppercase tracking-widest font-bold">Empty</div>)}</div>); }) : <div className="col-span-full text-center py-12 text-slate-500 italic">No routes defined for {currentDepot}. Click "Add Route" to begin.</div>}</div>
                    {selectedSlot && (<div className="fixed inset-0 bg-black/80 backdrop-blur-lg flex items-center justify-center z-50 p-4 animate-fade-in" onClick={() => setSelectedSlot(null)}><div className="gloss-panel rounded-2xl p-6 w-full max-w-md shadow-2xl" onClick={e => e.stopPropagation()}><h3 className="text-xl font-bold text-white mb-4">Assign Driver to Route {selectedSlot}</h3><div className="space-y-2 max-h-96 overflow-y-auto custom-scroll pr-2">{activeDrivers.sort((a,b) => a.name.localeCompare(b.name)).map(d => (<button key={d.id} onClick={() => handleAssign(d.id)} className="w-full text-left p-4 rounded-xl hover:bg-white/10 text-slate-300 hover:text-white border border-transparent hover:border-white/10 flex justify-between items-center transition-all"><span className="font-bold">{d.name}</span>{d.shift === 'Night' ? <span className="flex items-center text-xs text-indigo-400 bg-indigo-900/20 px-2 py-1 rounded border border-indigo-500/20"><Icons.Moon className="w-3 h-3 mr-1"/> Night</span> : <span className="flex items-center text-xs text-amber-400 bg-amber-900/20 px-2 py-1 rounded border border-amber-500/20"><Icons.Sun className="w-3 h-3 mr-1"/> Day</span>}</button>))}</div><button onClick={() => setSelectedSlot(null)} className="mt-6 w-full py-3 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-xl transition-colors font-bold btn-gloss">Cancel</button></div></div>)}
                    {isAdding && (<div className="fixed inset-0 bg-black/80 backdrop-blur-lg flex items-center justify-center z-50 p-4 animate-fade-in" onClick={() => setIsAdding(false)}><div className="gloss-panel rounded-2xl p-6 w-full max-w-sm shadow-2xl" onClick={e => e.stopPropagation()}><h3 className="text-xl font-bold text-white mb-4">Add New Route</h3><form onSubmit={handleAddRouteSubmit} className="space-y-4"><div><label className="text-xs text-slate-400 uppercase font-bold mb-2 block">Route Number</label><input type="number" autoFocus className="w-full input-gloss rounded-lg p-3 text-lg font-bold text-center" placeholder="e.g. 126" value={newRouteNum} onChange={e => setNewRouteNum(e.target.value)} /></div><button type="submit" className="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-xl transition-colors font-bold btn-gloss">Create Route</button><button type="button" onClick={() => setIsAdding(false)} className="w-full py-3 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-xl transition-colors font-bold btn-gloss">Cancel</button></form></div></div>)}
                </div>
            );
        };
        const CustomerProfile = ({ customer, issues, onBack, onAddIssue, onDeleteIssue, onResolveIssue }) => {
            const [newIssue, setNewIssue] = useState({ date: getLocalDateString(new Date()), unitNum: '', issue: '', status: 'Open' });
            const handleAdd = (e) => { e.preventDefault(); if(!newIssue.unitNum || !newIssue.issue) return; onAddIssue({ ...newIssue, customerId: customer.id }); setNewIssue({ ...newIssue, unitNum: '', issue: '' }); };
            return (
                <div className="space-y-8 animate-fade-in max-w-7xl mx-auto relative z-20">
                    <button onClick={onBack} className="flex items-center text-slate-400 hover:text-white mb-4 px-4 py-2 rounded-full bg-slate-800 hover:bg-slate-700 transition-all w-fit btn-gloss text-sm"><Icons.ChevronLeft className="w-4 h-4 mr-1"/> Back to Customers</button>
                    <div className="gloss-panel rounded-3xl p-8 flex items-center gap-6 shadow-2xl"><div className="w-20 h-20 rounded-full bg-gradient-to-br from-orange-900 to-orange-950 text-orange-500 flex items-center justify-center border border-white/10 shadow-[0_0_30px_rgba(249,115,22,0.2)]"><Icons.Archive className="w-10 h-10 drop-shadow-md"/></div><div><h1 className="text-5xl font-black text-white drop-shadow-lg">{customer.name}</h1>{customer.address && <div className="text-slate-400 text-lg mt-1">{customer.address}</div>}</div></div>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div className="gloss-panel rounded-2xl p-6"><h3 className="text-xl font-bold text-white mb-6 flex items-center"><Icons.AlertTriangle className="w-5 h-5 mr-3 text-red-500"/> Report Issue</h3><form onSubmit={handleAdd} className="space-y-4"><div className="flex gap-3"><input type="date" className="input-gloss rounded-lg p-3 text-sm" value={newIssue.date} onChange={e => setNewIssue({...newIssue, date: e.target.value})} /><input type="text" placeholder="Compactor #" className="input-gloss rounded-lg p-3 text-sm flex-1" value={newIssue.unitNum} onChange={e => setNewIssue({...newIssue, unitNum: e.target.value})} /></div><textarea placeholder="Describe the issue in detail..." className="w-full input-gloss rounded-lg p-3 text-sm h-32 resize-none" value={newIssue.issue} onChange={e => setNewIssue({...newIssue, issue: e.target.value})} /><button type="submit" className="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-3 rounded-lg text-sm shadow-lg shadow-red-900/30 transition-all btn-gloss">Log Service Issue</button></form></div>
                        <div className="gloss-panel rounded-2xl p-6"><h3 className="text-xl font-bold text-white mb-6 flex items-center"><Icons.History className="w-5 h-5 mr-3 text-slate-400"/> Service History</h3><div className="space-y-4 max-h-[500px] overflow-y-auto custom-scroll pr-2">{issues.filter(i => i.customerId === customer.id).sort((a,b) => new Date(b.date) - new Date(a.date)).map(issue => { const isResolved = issue.status === 'Resolved'; return (<div key={issue.id} className={`border p-4 rounded-xl transition-all ${isResolved ? 'bg-emerald-900/10 border-emerald-500/20 opacity-75' : 'bg-white/5 border-white/5 hover:bg-white/10'}`}><div className="flex justify-between items-start mb-2"><div className="flex items-center gap-2"><div className={`font-mono font-bold text-xs px-2 py-1 rounded border ${isResolved ? 'text-emerald-400 border-emerald-500/20 bg-emerald-900/30' : 'text-orange-400 border-orange-500/20 bg-black/40'}`}>{issue.date}  Unit #{issue.unitNum}</div>{isResolved && <span className="text-[10px] font-bold uppercase text-emerald-500 flex items-center"><Icons.CheckCircle className="w-3 h-3 mr-1"/> Resolved</span>}</div><div className="flex gap-2">{!isResolved && (<button onClick={() => onResolveIssue(issue.id)} title="Mark Resolved" className="text-emerald-500 hover:text-emerald-400 hover:bg-emerald-900/30 p-1 rounded transition-colors"><Icons.CheckCircle className="w-5 h-5"/></button>)}<button onClick={() => onDeleteIssue(issue.id)} title="Delete Record" className="text-slate-600 hover:text-red-500 p-1 rounded transition-colors"><Icons.Trash2 className="w-4 h-4"/></button></div></div><div className={`text-sm leading-relaxed ${isResolved ? 'text-slate-400 line-through' : 'text-slate-300'}`}>{issue.issue}</div></div>); })}{issues.filter(i => i.customerId === customer.id).length === 0 && <div className="text-center text-slate-500 italic mt-8">No issues reported.</div>}</div></div>
                    </div>
                </div>
            );
        };

        function App() {
            const [activeTab, setActiveTab] = useState('home');
            const [currentDepot, setCurrentDepot] = useState('Jersey City');
            const [trucks, setTrucks] = useState([]); const [drivers, setDrivers] = useState([]); const [tasks, setTasks] = useState([]); const [schedule, setSchedule] = useState([]); const [exceptions, setExceptions] = useState([]); const [incidents, setIncidents] = useState([]); const [maintenanceLogs, setMaintenanceLogs] = useState([]); const [hoistChecks, setHoistChecks] = useState([]); const [customers, setCustomers] = useState([]); const [compactorIssues, setCompactorIssues] = useState([]); const [driverDocuments, setDriverDocuments] = useState([]); const [generalDocuments, setGeneralDocuments] = useState([]); const [routes, setRoutes] = useState([]); const [dailyHours, setDailyHours] = useState([]); const [driverJobs, setDriverJobs] = useState([]); const [calendarEvents, setCalendarEvents] = useState([]);
            const [viewingDriverId, setViewingDriverId] = useState(null); const [viewingTruckId, setViewingTruckId] = useState(null); const [viewingCustomerId, setViewingCustomerId] = useState(null); const [viewingHoistBoard, setViewingHoistBoard] = useState(false); const [loading, setLoading] = useState(true); const [newTruckNum, setNewTruckNum] = useState(''); const [newDriverName, setNewDriverName] = useState(''); const [newDriverShift, setNewDriverShift] = useState('Day'); const [newDriverTime, setNewDriverTime] = useState(''); const [showAddTruck, setShowAddTruck] = useState(false); const [showAddDriver, setShowAddDriver] = useState(false); const [editingDriverId, setEditingDriverId] = useState(null); const [editDriverData, setEditDriverData] = useState({}); const [calcDrivers, setCalcDrivers] = useState(''); const [calcBoxes, setCalcBoxes] = useState(''); const [isOnline, setIsOnline] = useState(false); const [showArchivedDrivers, setShowArchivedDrivers] = useState(false);

            const filterByDepot = (items) => items.filter(i => (i.depot || 'Jersey City') === currentDepot);
            const currentTrucks = filterByDepot(trucks);
            const currentDrivers = filterByDepot(drivers);
            
            const calcEfficiency = () => { if(!calcDrivers || !calcBoxes) return null; const val = (parseFloat(calcBoxes) / parseFloat(calcDrivers)).toFixed(1); return isNaN(val) ? null : val; };
            const efficiencyVal = calcEfficiency();

            useEffect(() => {
                const initAuth = async () => { try { await auth.signInAnonymously(); } catch (error) { console.error(error); } }; initAuth();
                const checkOnline = () => setIsOnline(navigator.onLine); window.addEventListener('online', checkOnline); window.addEventListener('offline', checkOnline); checkOnline(); setLoading(false);
                const unsubTrucks = db.collection('trucks').onSnapshot(s => setTrucks(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                const unsubDrivers = db.collection('drivers').onSnapshot(s => setDrivers(s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => a.name.localeCompare(b.name))));
                const unsubTasks = db.collection('tasks').orderBy('createdAt', 'asc').onSnapshot(s => setTasks(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                const unsubSchedule = db.collection('schedule').orderBy('date', 'asc').onSnapshot(s => setSchedule(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                const unsubExceptions = db.collection('schedule_exceptions').onSnapshot(s => setExceptions(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                const unsubIncidents = db.collection('incidents').orderBy('date', 'desc').onSnapshot(s => setIncidents(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                const unsubMaintenance = db.collection('maintenance_logs').orderBy('date', 'desc').onSnapshot(s => setMaintenanceLogs(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                const unsubHoists = db.collection('hoist_checks').onSnapshot(s => setHoistChecks(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                const unsubCustomers = db.collection('customers').onSnapshot(s => setCustomers(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                const unsubCompactorIssues = db.collection('compactor_issues').orderBy('date', 'desc').onSnapshot(s => setCompactorIssues(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                const unsubDocs = db.collection('driver_documents').orderBy('uploadedAt', 'desc').onSnapshot(s => setDriverDocuments(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                const unsubGenDocs = db.collection('general_documents').orderBy('uploadedAt', 'desc').onSnapshot(s => setGeneralDocuments(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                const unsubRoutes = db.collection('routes').onSnapshot(s => setRoutes(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                const unsubDailyHours = db.collection('daily_hours').onSnapshot(s => setDailyHours(s.docs.map(d => ({ id: d.id, ...d.data() })))); 
                const unsubJobs = db.collection('driver_jobs').onSnapshot(s => setDriverJobs(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                const unsubCalendar = db.collection('calendar_events').orderBy('date', 'asc').onSnapshot(s => setCalendarEvents(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                return () => { unsubTrucks(); unsubDrivers(); unsubTasks(); unsubSchedule(); unsubExceptions(); unsubIncidents(); unsubMaintenance(); unsubHoists(); unsubCustomers(); unsubCompactorIssues(); unsubDocs(); unsubGenDocs(); unsubRoutes(); unsubDailyHours(); unsubJobs(); unsubCalendar(); window.removeEventListener('online', checkOnline); window.removeEventListener('offline', checkOnline); };
            }, []);

            const addTruck = async (e) => { e.preventDefault(); if(!newTruckNum.trim()) return; await db.collection('trucks').add({ number: newTruckNum.toUpperCase(), status: 'Active', dayDriverId: null, nightDriverId: null, notes: '', depot: currentDepot, createdAt: firebase.firestore.FieldValue.serverTimestamp() }); setNewTruckNum(''); setShowAddTruck(false); };
            const updateTruck = (id, data) => db.collection('trucks').doc(id).update(data);
            const deleteTruck = (id) => { if(window.confirm("Delete?")) db.collection('trucks').doc(id).delete(); };
            const addDriver = async (e) => { e.preventDefault(); if(!newDriverName.trim()) return; await db.collection('drivers').add({ name: newDriverName, shift: newDriverShift, startTime: newDriverTime || "00:00", defaultSchedule: [1,2,3,4,5], status: 'Active', startDate: getLocalDateString(new Date()), depot: currentDepot, createdAt: firebase.firestore.FieldValue.serverTimestamp() }); setNewDriverName(''); setNewDriverTime(''); setShowAddDriver(false); };
            const deleteDriver = (id) => { if(window.confirm("Are you sure you want to permanently delete this driver?")) db.collection('drivers').doc(id).delete(); };
            const archiveDriver = (id) => { if(window.confirm("Archive driver?")) db.collection('drivers').doc(id).update({ status: 'Archived', archivedDate: getLocalDateString(new Date()) }); };
            const updateDriver = (id, data) => db.collection('drivers').doc(id).update(data);
            const startEditDriver = (driver) => { setEditingDriverId(driver.id); setEditDriverData({ ...driver }); };
            const saveDriver = async () => { await db.collection('drivers').doc(editingDriverId).update(editDriverData); setEditingDriverId(null); };
            const cancelEditDriver = () => { setEditingDriverId(null); };
            const updateDriverSchedule = (id, scheduleArray) => { db.collection('drivers').doc(id).update({ defaultSchedule: scheduleArray }); };
            const addTask = (text) => db.collection('tasks').add({ text, completed: false, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
            const toggleTask = (task) => db.collection('tasks').doc(task.id).update({ completed: !task.completed });
            const deleteTask = (id) => db.collection('tasks').doc(id).delete();
            const addExceptionFromProfile = (data) => db.collection('schedule_exceptions').add(data);
            const deleteException = (id) => db.collection('schedule_exceptions').doc(id).delete();
            const addIncident = (data) => db.collection('incidents').add(data);
            const deleteIncident = (id) => db.collection('incidents').doc(id).delete();
            const addMaintenanceLog = (data) => db.collection('maintenance_logs').add(data);
            const deleteMaintenanceLog = (id) => db.collection('maintenance_logs').doc(id).delete();
            const checkHoist = (data) => db.collection('hoist_checks').add(data);
            const addCustomer = (data) => db.collection('customers').add({...data, status: 'Active'});
            const archiveCustomer = (id) => db.collection('customers').doc(id).update({ status: 'Archived' });
            const restoreCustomer = (id) => db.collection('customers').doc(id).update({ status: 'Active' });
            const deleteCustomer = (id) => { if(window.confirm("Delete Customer?")) db.collection('customers').doc(id).delete(); };
            const addCompactorIssue = (data) => db.collection('compactor_issues').add(data);
            const resolveCompactorIssue = (id) => db.collection('compactor_issues').doc(id).update({ status: 'Resolved' });
            const deleteCompactorIssue = (id) => db.collection('compactor_issues').doc(id).delete();
            const deleteDocument = (id) => { if(window.confirm("Delete document?")) { db.collection('driver_documents').doc(id).delete(); } }
            const deleteGeneralDoc = (id) => { if(window.confirm("Delete document?")) { db.collection('general_documents').doc(id).delete(); } }
            const updateRoute = (id, data) => { if(id) db.collection('routes').doc(id).update(data); else db.collection('routes').add(data); };
            const deleteRoute = (id) => db.collection('routes').doc(id).delete();
            const uploadDocument = async (driverId, file, incidentId = null) => { if (!file) return; const storageRef = storage.ref(); const fileRef = storageRef.child(`drivers/${driverId}/${Date.now()}_${file.name}`); try { const snapshot = await fileRef.put(file); const url = await snapshot.ref.getDownloadURL(); const docData = { driverId, name: file.name, url, uploadedAt: firebase.firestore.FieldValue.serverTimestamp() }; if (incidentId) docData.incidentId = incidentId; await db.collection('driver_documents').add(docData); } catch (error) { alert("Upload failed: " + error.message); console.error(error); } };
            const uploadGeneralDoc = async (file) => { if (!file) return; const storageRef = storage.ref(); const fileRef = storageRef.child(`general/${Date.now()}_${file.name}`); try { const snapshot = await fileRef.put(file); const url = await snapshot.ref.getDownloadURL(); await db.collection('general_documents').add({ name: file.name, url: url, uploadedAt: firebase.firestore.FieldValue.serverTimestamp() }); } catch (error) { alert("Upload failed: " + error.message); console.error(error); } };
            const updateHours = (driverId, date, hours) => { const docId = `${driverId}_${date}`; db.collection('daily_hours').doc(docId).set({ driverId, date, hours: parseFloat(hours) || 0 }, { merge: true }); };
            const addJob = (jobData) => db.collection('driver_jobs').add(jobData);
            const toggleJob = (id, status) => db.collection('driver_jobs').doc(id).update({ completed: status });
            const deleteJob = (id) => db.collection('driver_jobs').doc(id).delete();
            const addCalendarEvent = (evt) => db.collection('calendar_events').add(evt);
            const deleteCalendarEvent = (id) => db.collection('calendar_events').doc(id).delete();

            const totalTrucks = currentTrucks.length;
            const downTrucks = currentTrucks.filter(t => t.status === 'Down').length;
            const shopTrucks = currentTrucks.filter(t => t.status === 'Shop').length;
            const doubleShifted = currentTrucks.filter(t => t.dayDriverId && isValidDriver(t.dayDriverId, currentDrivers) && t.nightDriverId && isValidDriver(t.nightDriverId, currentDrivers)).length;
            const activeUnassigned = currentTrucks.filter(t => t.status === 'Active' && (!t.dayDriverId || !isValidDriver(t.dayDriverId, currentDrivers)) && (!t.nightDriverId || !isValidDriver(t.nightDriverId, currentDrivers)));
            const activeDoubleShifted = currentTrucks.filter(t => t.status === 'Active' && t.dayDriverId && isValidDriver(t.dayDriverId, currentDrivers) && t.nightDriverId && isValidDriver(t.nightDriverId, currentDrivers));
            const activeSingleShifted = currentTrucks.filter(t => t.status === 'Active' && ((t.dayDriverId && isValidDriver(t.dayDriverId, currentDrivers) && (!t.nightDriverId || !isValidDriver(t.nightDriverId, currentDrivers))) || ((!t.dayDriverId || !isValidDriver(t.dayDriverId, currentDrivers)) && t.nightDriverId && isValidDriver(t.nightDriverId, currentDrivers))));
            const maintenanceList = currentTrucks.filter(t => t.status !== 'Active');

            if (loading) return <div className="h-screen w-full flex flex-col items-center justify-center bg-slate-950 text-white font-sans"><Icons.Spinner className="w-12 h-12 text-blue-500 mb-4"/><div className="text-lg font-light tracking-widest animate-pulse text-blue-400">LOADING COMMAND CENTER...</div></div>;
            
            if (viewingTruckId) { const truck = trucks.find(t => t.id === viewingTruckId); if (!truck) { setViewingTruckId(null); return null; } return <div className="min-h-screen p-8 pb-20 pt-24 relative"><nav className="fixed top-0 left-0 right-0 z-50 bg-slate-900/70 backdrop-blur-xl border-b border-white/10 shadow-2xl h-20 flex items-center px-8"><div className="flex items-center gap-4"><div className="bg-gradient-to-b from-blue-500 to-blue-700 p-2.5 rounded-xl shadow-lg"><Icons.Truck className="text-white w-6 h-6"/></div><div><h1 className="text-2xl font-black bg-gradient-to-b from-white to-slate-400 bg-clip-text text-transparent">Roll Off Command Center</h1></div></div></nav><TruckProfile truck={truck} logs={maintenanceLogs} hoistChecks={hoistChecks} onBack={() => setViewingTruckId(null)} onAddLog={addMaintenanceLog} onDeleteLog={deleteMaintenanceLog} onCheckHoist={checkHoist} /></div>; }
            if (viewingDriverId) { const drv = drivers.find(d => d.id === viewingDriverId); if (!drv) { setViewingDriverId(null); return null; } return <div className="min-h-screen p-8 pb-20 pt-24 relative"><nav className="fixed top-0 left-0 right-0 z-50 bg-slate-900/70 backdrop-blur-xl border-b border-white/10 shadow-2xl h-20 flex items-center px-8"><div className="flex items-center gap-4"><div className="bg-gradient-to-b from-blue-500 to-blue-700 p-2.5 rounded-xl shadow-lg"><Icons.Truck className="text-white w-6 h-6"/></div><div><h1 className="text-2xl font-black bg-gradient-to-b from-white to-slate-400 bg-clip-text text-transparent">Roll Off Command Center</h1></div></div></nav><DriverProfile driver={drv} trucks={trucks} exceptions={exceptions} incidents={incidents} documents={driverDocuments} dailyHours={dailyHours} driverJobs={driverJobs} onBack={() => setViewingDriverId(null)} onUpdateDriver={updateDriver} onArchiveDriver={archiveDriver} onDeleteDriver={deleteDriver} onAddException={addExceptionFromProfile} onDeleteException={deleteException} onAddIncident={addIncident} onDeleteIncident={deleteIncident} onUploadDocument={uploadDocument} onDeleteDocument={deleteDocument} onUpdateHours={updateHours} onAddJob={addJob} onToggleJob={toggleJob} onDeleteJob={deleteJob} /></div>; }
            if (viewingCustomerId) { const cust = customers.find(c => c.id === viewingCustomerId); if (!cust) { setViewingCustomerId(null); return null; } return <div className="min-h-screen p-8 pb-20 pt-24 relative"><nav className="fixed top-0 left-0 right-0 z-50 bg-slate-900/70 backdrop-blur-xl border-b border-white/10 shadow-2xl h-20 flex items-center px-8"><div className="flex items-center gap-4"><div className="bg-gradient-to-b from-blue-500 to-blue-700 p-2.5 rounded-xl shadow-lg"><Icons.Truck className="text-white w-6 h-6"/></div><div><h1 className="text-2xl font-black bg-gradient-to-b from-white to-slate-400 bg-clip-text text-transparent">Roll Off Command Center</h1></div></div></nav><CustomerProfile customer={cust} issues={compactorIssues} onBack={() => setViewingCustomerId(null)} onAddIssue={addCompactorIssue} onDeleteIssue={deleteCompactorIssue} onResolveIssue={resolveCompactorIssue} /></div>; }

            const navItems = [ { id: 'home', label: 'Home', icon: Icons.Home }, { id: 'calendar', label: 'Calendar', icon: Icons.Calendar }, { id: 'fleet', label: 'Fleet', icon: Icons.Truck }, { id: 'routes', label: 'Routes', icon: Icons.Map }, { id: 'schedule', label: 'Schedule', icon: Icons.Calendar }, { id: 'tasks', label: 'Tasks', icon: Icons.ListTodo }, { id: 'drivers', label: 'Drivers', icon: Icons.Users }, { id: 'compactors', label: 'Clients', icon: Icons.Archive }, { id: 'docs', label: 'Vault', icon: Icons.FileText } ];

            return (
                <div className="min-h-screen flex flex-col relative">
                    <nav className="fixed top-0 left-0 right-0 z-50 bg-slate-900/70 backdrop-blur-xl border-b border-white/10 shadow-2xl">
                        <div className="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex items-center justify-between h-20">
                                <div className="flex items-center gap-4 cursor-pointer group" onClick={() => setActiveTab('home')}>
                                    <div className="bg-gradient-to-b from-blue-500 to-blue-700 p-2.5 rounded-xl shadow-lg shadow-blue-500/30 border border-white/20 group-hover:shadow-blue-500/50 transition-all group-hover:scale-105"><Icons.Truck className="text-white w-6 h-6 drop-shadow" /></div>
                                    <div><h1 className="text-2xl font-black bg-gradient-to-b from-white to-slate-400 bg-clip-text text-transparent tracking-tight drop-shadow-sm">Roll Off Command Center</h1><p className="text-[10px] text-blue-400 font-bold uppercase tracking-widest drop-shadow">Donovan Logistics</p></div>
                                </div>
                                <div className="hidden md:flex items-center gap-2 bg-black/20 p-1.5 rounded-full border border-white/5 shadow-inner">{navItems.map(item => (<button key={item.id} onClick={() => setActiveTab(item.id)} className={`flex items-center px-4 py-2 rounded-full text-sm font-bold transition-all duration-200 ${activeTab === item.id ? 'nav-pill-active text-white' : 'text-slate-400 hover:text-white hover:bg-white/5'}`}><item.icon className={`w-4 h-4 mr-2 ${activeTab === item.id ? 'text-blue-300 drop-shadow' : ''}`} /> {item.label}</button>))}</div>
                                <div className="flex items-center gap-3"><div className={`flex items-center gap-2 px-3 py-1.5 rounded-full border text-[10px] font-black uppercase tracking-widest shadow-lg ${isOnline ? 'bg-emerald-900/40 border-emerald-500/30 text-emerald-400 shadow-emerald-900/20' : 'bg-red-900/40 border-red-500/30 text-red-400'}`}><div className={`w-2 h-2 rounded-full ${isOnline ? 'bg-emerald-400 shadow-[0_0_10px_rgba(52,211,153,0.8)] animate-pulse' : 'bg-red-400'}`}></div>{isOnline ? "ONLINE" : "OFFLINE"}</div></div>
                            </div>
                        </div>
                    </nav>

                    <main className="flex-1 max-w-8xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full mt-24 mb-10">
                        {/* Depot Selector */}
                        <div className="flex justify-center mb-8 animate-fade-in relative z-20">
                            <div className="bg-slate-900/80 p-1.5 rounded-full border border-white/10 flex gap-1 shadow-2xl backdrop-blur-md">
                                {DEPOTS.map(depot => (
                                    <button key={depot} onClick={() => setCurrentDepot(depot)} className={`px-6 py-2 rounded-full text-sm font-bold transition-all duration-300 ${currentDepot === depot ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/30 scale-105' : 'text-slate-400 hover:text-white hover:bg-white/5'}`}>
                                        {depot}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {activeTab === 'home' && (
                            <div className="space-y-8 animate-fade-in">
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-6">
                                    <div className="gloss-panel p-6 rounded-2xl relative overflow-hidden group"><div className="absolute -right-6 -top-6 text-white/5 group-hover:text-white/10 transition-colors"><Icons.Truck className="w-32 h-32"/></div><div className="text-slate-400 text-xs font-bold uppercase tracking-widest">Total Fleet ({currentDepot})</div><div className="text-5xl font-black text-white mt-2 relative z-10 drop-shadow-lg">{totalTrucks}</div></div>
                                    <div className="gloss-panel p-6 rounded-2xl relative overflow-hidden group"><div className="absolute inset-0 bg-emerald-600/10 mix-blend-overlay"></div><div className="absolute -right-6 -top-6 text-emerald-500/10 group-hover:text-emerald-500/20 transition-colors"><Icons.Zap className="w-32 h-32"/></div><div className="text-emerald-400 text-xs font-bold uppercase tracking-widest relative z-10">Double Shifted</div><div className="text-5xl font-black text-white mt-2 relative z-10 drop-shadow-lg">{doubleShifted}</div></div>
                                    <div className="gloss-panel p-6 rounded-2xl relative overflow-hidden group"><div className="absolute inset-0 bg-red-600/10 mix-blend-overlay"></div><div className="absolute -right-6 -top-6 text-red-500/10 group-hover:text-red-500/20 transition-colors"><Icons.Wrench className="w-32 h-32"/></div><div className="text-red-400 text-xs font-bold uppercase tracking-widest relative z-10">Maintenance</div><div className="text-5xl font-black text-white mt-2 relative z-10 drop-shadow-lg">{downTrucks + shopTrucks}</div></div>
                                    <div className="gloss-panel p-6 rounded-2xl relative overflow-hidden group"><div className="absolute inset-0 bg-purple-600/10 mix-blend-overlay"></div><div className="absolute -right-6 -top-6 text-purple-500/10 group-hover:text-purple-500/20 transition-colors"><Icons.ListTodo className="w-32 h-32"/></div><div className="text-purple-400 text-xs font-bold uppercase tracking-widest relative z-10">Pending Tasks</div><div className="text-5xl font-black text-white mt-2 relative z-10 drop-shadow-lg">{tasks.filter(t => !t.completed).length}</div></div>
                                </div>

                                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                    <div className="lg:col-span-2 space-y-8">
                                        <div className="gloss-panel rounded-3xl p-8">
                                            <div className="flex items-center justify-between mb-6">
                                                <h3 className="text-xl font-bold text-white flex items-center drop-shadow-md"><Icons.Users className="w-6 h-6 mr-3 text-orange-500"/> Staffing Outlook</h3>
                                                <span className="text-xs font-mono text-slate-400 bg-black/30 border border-white/10 px-3 py-1 rounded-full">{new Date().toLocaleDateString()}</span>
                                            </div>
                                            
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                                <div>
                                                    <h4 className="text-xs font-black text-slate-400 uppercase mb-4 flex items-center gap-2 tracking-wider"><span className="w-2 h-2 bg-blue-500 rounded-full animate-pulse shadow-[0_0_10px_rgba(59,130,246,0.8)]"></span> Today's Roster ({currentDepot})</h4>
                                                    <div className="space-y-3 max-h-[400px] overflow-y-auto custom-scroll pr-2">
                                                        {(() => { const today = getLocalDateString(new Date()); const dayOfWeek = new Date().getDay(); const driversList = currentDrivers.map(d => { 
                                                            if (d.status === 'Archived') return { ...d, status: 'OFF' }; 
                                                            const isActive = d.defaultSchedule && d.defaultSchedule.includes(dayOfWeek); 
                                                            const ex = exceptions.find(e => e.driverId === d.id && e.date === today); 
                                                            let status = 'OFF'; if (isActive) status = 'WORKING'; if (ex) status = ex.type; 
                                                            if (d.startDate && today < d.startDate) status = 'OFF';
                                                            return { ...d, status }; 
                                                        }); const workingDrivers = driversList.filter(d => d.status === 'WORKING' || d.status === 'EXTRA'); const outDrivers = driversList.filter(d => d.status === 'OUT' || d.status === 'VACATION'); const dayCrew = workingDrivers.filter(d => (d.shift || 'Day') === 'Day'); const nightCrew = workingDrivers.filter(d => d.shift === 'Night'); return (<>
                                                            {outDrivers.length > 0 && (<div className="space-y-2 mb-4">{outDrivers.map(driver => (<div key={driver.id} className="flex items-center justify-between bg-red-900/20 p-3 rounded-xl border border-red-500/30 shadow-inner"><div className="flex items-center gap-3"><div className="w-8 h-8 rounded-lg flex items-center justify-center bg-red-500/20 text-red-400 font-bold text-sm border border-red-500/20"><Icons.XCircle className="w-5 h-5"/></div><div className="font-bold text-slate-300 decoration-red-500/50 line-through">{driver.name}</div></div><span className={`text-[10px] font-black px-2 py-1 rounded-md tracking-wide shadow-md ${driver.status === 'OUT' ? 'bg-gradient-to-b from-red-500 to-red-700 text-white border border-white/20' : 'bg-gradient-to-b from-teal-500 to-teal-700 text-white border border-white/20'}`}>{driver.status === 'OUT' ? 'CALL OUT' : 'VACATION'}</span></div>))}</div>)}
                                                            {dayCrew.length > 0 && (<div className="mb-4"><div className="text-[10px] uppercase font-bold text-amber-500 mb-2 flex items-center tracking-wider opacity-80"><Icons.Sun className="w-3 h-3 mr-1"/> Day Shift</div>{dayCrew.map(driver => { let truckNum = "Unassigned"; let isAssigned = false; const assignedTruck = currentTrucks.find(t => (driver.shift === 'Day' && t.dayDriverId === driver.id) || (driver.shift === 'Night' && t.nightDriverId === driver.id)); if (assignedTruck) { truckNum = assignedTruck.number; isAssigned = true; } else if (driver.defaultTruckId) { const defTruck = currentTrucks.find(t => t.id === driver.defaultTruckId); if(defTruck) truckNum = defTruck.number + " (Pref)"; } return (<div key={driver.id} className="flex items-center justify-between bg-white/5 p-2 rounded-lg border border-white/10 mb-2 hover:bg-white/10 transition-colors cursor-pointer shadow-sm" onClick={() => setViewingDriverId(driver.id)}><div className="flex items-center gap-3"><div className="w-6 h-6 rounded bg-gradient-to-br from-amber-600 to-amber-800 text-white flex items-center justify-center border border-white/20 shadow-sm"><Icons.Sun className="w-3 h-3"/></div><div className="font-medium text-slate-200 text-sm">{driver.name}</div></div><div className="text-right">{isAssigned ? <span className="font-mono font-bold text-blue-300 text-xs bg-blue-900/30 px-2 py-1 rounded border border-blue-500/30 shadow-inner">{truckNum}</span> : <span className="text-[10px] font-bold text-yellow-500 bg-yellow-900/20 px-2 py-1 rounded border border-yellow-900/50">NO TRUCK</span>}</div></div>); })}</div>)}
                                                            {nightCrew.length > 0 && (<div><div className="text-[10px] uppercase font-bold text-indigo-400 mb-2 flex items-center tracking-wider opacity-80"><Icons.Moon className="w-3 h-3 mr-1"/> Night Shift</div>{nightCrew.map(driver => { let truckNum = "Unassigned"; let isAssigned = false; const assignedTruck = currentTrucks.find(t => (driver.shift === 'Day' && t.dayDriverId === driver.id) || (driver.shift === 'Night' && t.nightDriverId === driver.id)); if (assignedTruck) { truckNum = assignedTruck.number; isAssigned = true; } else if (driver.defaultTruckId) { const defTruck = currentTrucks.find(t => t.id === driver.defaultTruckId); if(defTruck) truckNum = defTruck.number + " (Pref)"; } return (<div key={driver.id} className="flex items-center justify-between bg-white/5 p-2 rounded-lg border border-white/10 mb-2 hover:bg-white/10 transition-colors cursor-pointer shadow-sm" onClick={() => setViewingDriverId(driver.id)}><div className="flex items-center gap-3"><div className="w-6 h-6 rounded bg-gradient-to-br from-indigo-600 to-indigo-800 text-white flex items-center justify-center border border-white/20 shadow-sm"><Icons.Moon className="w-3 h-3"/></div><div className="font-medium text-slate-200 text-sm">{driver.name}</div></div><div className="text-right">{isAssigned ? <span className="font-mono font-bold text-blue-300 text-xs bg-blue-900/30 px-2 py-1 rounded border border-blue-500/30 shadow-inner">{truckNum}</span> : <span className="text-[10px] font-bold text-yellow-500 bg-yellow-900/20 px-2 py-1 rounded border border-yellow-900/50">NO TRUCK</span>}</div></div>); })}</div>)}
                                                        </>)})()}
                                                    </div>
                                                </div>
                                                <div className="opacity-70 hover:opacity-100 transition-opacity">
                                                    <h4 className="text-xs font-black text-slate-500 uppercase mb-4 tracking-wider">Tomorrow Forecast</h4>
                                                    <div className="space-y-2 max-h-[400px] overflow-y-auto custom-scroll pr-2 grayscale hover:grayscale-0 transition-all">
                                                        {(() => { const tmrw = new Date(); tmrw.setDate(tmrw.getDate() + 1); const tomorrowStr = getLocalDateString(tmrw); const tomorrowDay = tmrw.getDay(); const driversList = currentDrivers.map(d => { 
                                                            if (d.status === 'Archived' && d.archivedDate && tomorrowStr > d.archivedDate) return { ...d, status: 'OFF' };
                                                            if (d.startDate && tomorrowStr < d.startDate) return { ...d, status: 'OFF' };
                                                            const isActive = d.defaultSchedule && d.defaultSchedule.includes(tomorrowDay); 
                                                            const ex = exceptions.find(e => e.driverId === d.id && e.date === tomorrowStr); 
                                                            let status = 'OFF'; if (isActive) status = 'WORKING'; if (ex) status = ex.type; return { ...d, status }; 
                                                        }); const workingDrivers = driversList.filter(d => d.status === 'WORKING' || d.status === 'EXTRA'); const outDrivers = driversList.filter(d => d.status === 'OUT' || d.status === 'VACATION'); const dayCrew = workingDrivers.filter(d => (d.shift || 'Day') === 'Day'); const nightCrew = workingDrivers.filter(d => d.shift === 'Night'); return (<>
                                                            {outDrivers.length > 0 && (<div className="space-y-2 mb-4">{outDrivers.map(driver => (<div key={driver.id} className="flex items-center justify-between bg-black/20 p-2 rounded-lg border border-white/5"><div className="flex items-center gap-2"><div className="font-medium text-slate-500 text-sm line-through">{driver.name}</div></div><span className="text-[9px] font-bold bg-slate-700 text-slate-400 px-1.5 py-0.5 rounded">{driver.status === 'OUT' ? 'OUT' : 'VAC'}</span></div>))}</div>)}
                                                            {dayCrew.length > 0 && (<div className="mb-2"><div className="text-[10px] uppercase font-bold text-slate-600 mb-1">Day</div>{dayCrew.map(driver => {
                                                                let truckNum = "Unassigned"; let isAssigned = false;
                                                                const assignedTruck = currentTrucks.find(t => (driver.shift === 'Day' && t.dayDriverId === driver.id) || (driver.shift === 'Night' && t.nightDriverId === driver.id));
                                                                if (assignedTruck) { truckNum = assignedTruck.number; isAssigned = true; } else if (driver.defaultTruckId) { const defTruck = currentTrucks.find(t => t.id === driver.defaultTruckId); if(defTruck) truckNum = defTruck.number + " (Pref)"; }
                                                                return (<div key={driver.id} className="flex items-center justify-between p-1.5 text-sm text-slate-500 border-l border-slate-800 ml-1"><div>{driver.name}</div><div className="text-right text-[10px]">{isAssigned ? <span className="font-mono font-bold text-blue-400/70">{truckNum}</span> : <span className="text-slate-700">None</span>}</div></div>);
                                                            })}</div>)}
                                                            {nightCrew.length > 0 && (<div className="mb-2"><div className="text-[10px] uppercase font-bold text-slate-600 mb-1">Night</div>{nightCrew.map(driver => {
                                                                let truckNum = "Unassigned"; let isAssigned = false;
                                                                const assignedTruck = currentTrucks.find(t => (driver.shift === 'Day' && t.dayDriverId === driver.id) || (driver.shift === 'Night' && t.nightDriverId === driver.id));
                                                                if (assignedTruck) { truckNum = assignedTruck.number; isAssigned = true; } else if (driver.defaultTruckId) { const defTruck = currentTrucks.find(t => t.id === driver.defaultTruckId); if(defTruck) truckNum = defTruck.number + " (Pref)"; }
                                                                return (<div key={driver.id} className="flex items-center justify-between p-1.5 text-sm text-slate-500 border-l border-slate-800 ml-1"><div>{driver.name}</div><div className="text-right text-[10px]">{isAssigned ? <span className="font-mono font-bold text-blue-400/70">{truckNum}</span> : <span className="text-slate-700">None</span>}</div></div>);
                                                            })}</div>)}
                                                        </>)})()}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="space-y-6">
                                        {/* Daily Operations Briefing Widget */}
                                        <div className="gloss-panel rounded-3xl p-6 relative overflow-hidden group">
                                            <div className="flex justify-between items-center mb-4">
                                                <h3 className="text-lg font-bold text-white flex items-center drop-shadow-md z-10"><Icons.Calendar className="w-5 h-5 mr-2 text-blue-400"/> Daily Briefing</h3>
                                                <button onClick={() => setActiveTab('calendar')} className="text-xs text-blue-400 hover:text-white transition-colors font-bold z-10 border border-blue-500/30 px-3 py-1 rounded-full bg-blue-900/20 hover:bg-blue-600">View Full Calendar</button>
                                            </div>
                                            <div className="relative z-10">
                                                <div className="text-5xl font-black text-white mb-2">{new Date().getDate()}</div>
                                                <div className="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4">{new Date().toLocaleString('default', { month: 'long', weekday: 'long' })}</div>
                                                <div className="space-y-2">
                                                    {(() => {
                                                        const todayStr = getLocalDateString(new Date());
                                                        const holidays = getHolidays(new Date().getFullYear()).filter(h => h.date === todayStr);
                                                        const todayEvents = calendarEvents.filter(e => e.date === todayStr);
                                                        const allToday = [...holidays, ...todayEvents];
                                                        
                                                        if (allToday.length === 0) return <div className="text-slate-500 text-xs italic">No specific events scheduled for today.</div>;
                                                        
                                                        return allToday.map((evt, idx) => (
                                                            <div key={idx} className={`text-xs p-2 rounded-lg flex items-center font-bold ${evt.type === 'Holiday' ? 'bg-red-900/30 text-red-300 border border-red-500/20' : 'bg-blue-900/30 text-blue-200 border border-blue-500/20'}`}>
                                                                <span className="w-1.5 h-1.5 rounded-full mr-2 flex-shrink-0 bg-current"></span>
                                                                {evt.time && <span className="mr-2 opacity-75">{evt.time}</span>}
                                                                <span className="truncate">{evt.title}</span>
                                                            </div>
                                                        ));
                                                    })()}
                                                </div>
                                            </div>
                                            <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><Icons.Calendar className="w-32 h-32 text-blue-500"/></div>
                                        </div>

                                        <div className="gloss-panel rounded-3xl p-6"><h3 className="text-lg font-bold text-white mb-4 flex items-center drop-shadow-md"><Icons.Calculator className="w-5 h-5 mr-2 text-teal-400"/> Efficiency Calculator</h3><div className="flex flex-col gap-4"><div className="flex gap-3"><div className="flex-1"><label className="text-[10px] text-slate-400 uppercase font-bold mb-1 block ml-1">Drivers</label><input type="number" className="w-full input-gloss rounded-lg p-2 text-center" value={calcDrivers} onChange={e => setCalcDrivers(e.target.value)} placeholder="0"/></div><div className="flex-1"><label className="text-[10px] text-slate-400 uppercase font-bold mb-1 block ml-1">Boxes</label><input type="number" className="w-full input-gloss rounded-lg p-2 text-center" value={calcBoxes} onChange={e => setCalcBoxes(e.target.value)} placeholder="0"/></div></div><div className={`p-4 rounded-xl text-center border shadow-inner transition-all ${!efficiencyVal ? 'bg-black/30 border-white/5' : efficiencyVal > 50 ? 'bg-red-900/30 border-red-500/30 shadow-red-900/20' : efficiencyVal > 30 ? 'bg-yellow-900/30 border-yellow-500/30 shadow-yellow-900/20' : 'bg-emerald-900/30 border-emerald-500/30 shadow-emerald-900/20'}`}><div className="text-4xl font-black text-white drop-shadow-lg">{efficiencyVal || "--"}</div><div className="text-[10px] uppercase tracking-widest opacity-60 mt-1 font-bold">Stops Per Driver</div></div></div></div>
                                        <div className="gloss-panel rounded-3xl p-6"><div className="flex justify-between items-center mb-4"><h3 className="text-lg font-bold text-white flex items-center drop-shadow-md"><Icons.ListTodo className="w-5 h-5 mr-2 text-purple-500"/> Quick Tasks</h3><button onClick={() => setActiveTab('tasks')} className="text-xs text-purple-400 hover:text-white transition-colors font-bold">View All</button></div><ul className="space-y-2">{tasks.filter(t => !t.completed).slice(0, 5).map(task => (<li key={task.id} className="flex items-center gap-3 p-2 hover:bg-white/5 rounded-lg transition-colors cursor-pointer group" onClick={() => toggleTask(task)}><div className="min-w-[16px] h-4 border border-slate-500 rounded group-hover:border-purple-400 transition-all shadow-sm"></div><span className="text-sm text-slate-300 truncate group-hover:text-white transition-colors">{task.text}</span></li>))}{tasks.filter(t => !t.completed).length === 0 && <li className="text-slate-500 italic text-center text-sm py-4">No pending tasks.</li>}</ul></div>
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {activeTab === 'calendar' && (<FullCalendar events={calendarEvents} onAddEvent={addCalendarEvent} onDeleteEvent={deleteCalendarEvent} />)}

                        {activeTab === 'drivers' && (
                            <div className="max-w-6xl mx-auto space-y-8 animate-fade-in">
                                <div className="flex justify-between items-center">
                                    <h2 className="text-2xl font-bold text-white drop-shadow-md">Driver Roster ({currentDepot})</h2>
                                    <div className="flex items-center gap-4">
                                        <label className="flex items-center cursor-pointer text-xs text-slate-400 hover:text-white transition-colors"><input type="checkbox" checked={showArchivedDrivers} onChange={() => setShowArchivedDrivers(!showArchivedDrivers)} className="mr-2" /> Show Archived</label>
                                        <button onClick={() => setShowAddDriver(!showAddDriver)} className="flex items-center gap-2 px-6 py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-full font-bold transition-all shadow-lg shadow-indigo-900/40 btn-gloss"><Icons.Plus className="w-5 h-5" /> Add Driver</button>
                                    </div>
                                </div>
                                {showAddDriver && (<form onSubmit={addDriver} className="gloss-panel p-6 rounded-2xl space-y-4"><div className="flex gap-4"><input type="text" placeholder="Driver Name" className="flex-1 input-gloss rounded-lg px-4 py-2" value={newDriverName} onChange={e => setNewDriverName(e.target.value)} /></div><div className="flex gap-4"><select value={newDriverShift} onChange={e => setNewDriverShift(e.target.value)} className="input-gloss rounded-lg px-4 py-2"><option value="Day">Day Shift</option><option value="Night">Night Shift</option></select><input type="time" value={newDriverTime} onChange={e => setNewDriverTime(e.target.value)} className="input-gloss rounded-lg px-4 py-2"/><button type="submit" className="flex-1 px-6 py-2 bg-emerald-600 text-white rounded-lg font-bold hover:bg-emerald-500 btn-gloss">Save Profile</button></div></form>)}
                                <div className="gloss-panel rounded-2xl overflow-hidden">
                                    <table className="w-full text-left"><thead className="bg-slate-900/50 text-slate-400 text-xs uppercase tracking-wider font-bold"><tr><th className="px-6 py-4">Name</th><th className="px-6 py-4 text-center">Shift Assignment</th><th className="px-6 py-4 text-right">Actions</th></tr></thead><tbody className="divide-y divide-white/5">{currentDrivers.filter(d => showArchivedDrivers || d.status !== 'Archived').map(driver => (<tr key={driver.id} className={`hover:bg-white/5 transition-colors cursor-pointer group ${driver.status === 'Archived' ? 'opacity-50 grayscale' : ''}`}>{editingDriverId === driver.id ? (<td colSpan={3} className="px-4 py-4"><div className="flex gap-3 items-center bg-black/30 p-3 rounded-xl border border-blue-500/30 shadow-inner"><input type="text" className="flex-1 input-gloss rounded px-3 py-2" value={editDriverData.name} onChange={(e) => setEditDriverData({...editDriverData, name: e.target.value})} /><select className="input-gloss rounded px-3 py-2" value={editDriverData.shift} onChange={(e) => setEditDriverData({...editDriverData, shift: e.target.value})}><option value="Day">Day</option><option value="Night">Night</option></select><select className="input-gloss rounded px-3 py-2" value={editDriverData.depot || 'Jersey City'} onChange={(e) => setEditDriverData({...editDriverData, depot: e.target.value})}>{DEPOTS.map(d=><option key={d} value={d}>{d}</option>)}</select><input type="time" className="input-gloss rounded px-3 py-2" value={editDriverData.startTime} onChange={(e) => setEditDriverData({...editDriverData, startTime: e.target.value})} /><button onClick={saveDriver} className="p-2 bg-emerald-600 text-white rounded hover:bg-emerald-500 btn-gloss"><Icons.Save className="w-4 h-4"/></button><button onClick={cancelEditDriver} className="p-2 bg-slate-700 text-white rounded hover:bg-slate-600 btn-gloss"><Icons.XCircle className="w-4 h-4"/></button></div></td>) : (<><td className="px-6 py-4" onClick={() => setViewingDriverId(driver.id)}><div className="flex items-center"><span className="font-bold text-white text-lg">{driver.name}</span>{driver.status === 'Archived' && <span className="ml-2 text-[10px] bg-red-900 px-2 py-0.5 rounded text-white">ARCHIVED</span>}</div></td><td className="px-6 py-4 text-center" onClick={() => setViewingDriverId(driver.id)}><div className="flex items-center justify-center gap-3">{driver.shift === 'Day' ? <span className="flex items-center px-3 py-1 rounded-full bg-amber-900/20 text-amber-400 border border-amber-500/30 text-xs font-bold uppercase tracking-wide shadow-sm"><Icons.Sun className="w-3 h-3 mr-1"/> Day</span> : <span className="flex items-center px-3 py-1 rounded-full bg-indigo-900/20 text-indigo-400 border border-indigo-500/30 text-xs font-bold uppercase tracking-wide shadow-sm"><Icons.Moon className="w-3 h-3 mr-1"/> Night</span>}<span className="text-slate-500 text-xs font-mono bg-black/20 px-2 py-1 rounded border border-white/5">{driver.startTime || "N/A"}</span></div></td><td className="px-6 py-4 text-right"><button onClick={(e) => { e.stopPropagation(); startEditDriver(driver); }} className="text-slate-500 hover:text-blue-400 transition-colors mr-3 p-2"><Icons.Pencil className="w-5 h-5" /></button><button onClick={(e) => { e.stopPropagation(); archiveDriver(driver.id); }} className="text-slate-500 hover:text-red-400 transition-colors p-2"><Icons.Archive className="w-5 h-5" /></button></td></>)}</tr>))}</tbody></table></div>
                            </div>
                        )}
                        {activeTab === 'fleet' && (
                            <div className="space-y-8 animate-fade-in">
                                {viewingHoistBoard ? (
                                    <HoistCheckBoard trucks={currentTrucks} hoistChecks={hoistChecks} onCheck={checkHoist} onBack={() => setViewingHoistBoard(false)} />
                                ) : (
                                    <>
                                        <div className="flex justify-between items-center">
                                            <h2 className="text-2xl font-bold text-white drop-shadow-md">Fleet Management ({currentDepot})</h2>
                                            <div className="flex gap-3">
                                                <button onClick={() => setViewingHoistBoard(true)} className="flex items-center gap-2 px-6 py-3 bg-purple-600 hover:bg-purple-500 text-white rounded-full font-bold transition-all shadow-lg shadow-purple-900/40 btn-gloss"><Icons.ClipboardCheck className="w-5 h-5" /> Hoist Alarm Checks</button>
                                                <button onClick={() => setShowAddTruck(!showAddTruck)} className="flex items-center gap-2 px-6 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-full font-bold transition-all shadow-lg shadow-blue-900/40 btn-gloss"><Icons.Plus className="w-5 h-5" /> Add Truck</button>
                                            </div>
                                        </div>
                                        {showAddTruck && (<form onSubmit={addTruck} className="gloss-panel p-6 rounded-2xl animate-fade-in max-w-xl mx-auto"><div className="flex gap-3"><input type="text" placeholder="Truck Number (e.g. R-105)" className="flex-1 input-gloss rounded-lg px-4 py-2" value={newTruckNum} onChange={e => setNewTruckNum(e.target.value)} /><button type="submit" className="px-6 py-2 bg-emerald-600 text-white rounded-lg font-bold hover:bg-emerald-500 btn-gloss">Create</button></div></form>)}
                                        <div className="space-y-8"><div><h3 className="text-sm font-black text-blue-400 uppercase tracking-widest mb-4 pl-1 drop-shadow-sm">Available In Yard <span className="ml-2 bg-black/40 border border-white/10 text-white px-2 py-0.5 rounded-full text-[10px] shadow-inner">{activeUnassigned.length}</span></h3><div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5">{activeUnassigned.map(truck => (<TruckCard key={truck.id} truck={truck} drivers={currentDrivers} onUpdate={updateTruck} onDelete={deleteTruck} onClick={() => setViewingTruckId(truck.id)}/>))}</div></div><div><h3 className="text-sm font-black text-purple-400 uppercase tracking-widest mb-4 pl-1 drop-shadow-sm">Double Shifted <span className="ml-2 bg-black/40 border border-white/10 text-white px-2 py-0.5 rounded-full text-[10px] shadow-inner">{activeDoubleShifted.length}</span></h3><div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5">{activeDoubleShifted.map(truck => (<TruckCard key={truck.id} truck={truck} drivers={currentDrivers} onUpdate={updateTruck} onDelete={deleteTruck} onClick={() => setViewingTruckId(truck.id)}/>))}</div></div><div><h3 className="text-sm font-black text-emerald-400 uppercase tracking-widest mb-4 pl-1 drop-shadow-sm">Single Shifted <span className="ml-2 bg-black/40 border border-white/10 text-white px-2 py-0.5 rounded-full text-[10px] shadow-inner">{activeSingleShifted.length}</span></h3><div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5">{activeSingleShifted.map(truck => (<TruckCard key={truck.id} truck={truck} drivers={currentDrivers} onUpdate={updateTruck} onDelete={deleteTruck} onClick={() => setViewingTruckId(truck.id)}/>))}</div></div><div className="pt-6 border-t border-white/5"><h3 className="text-sm font-black text-red-400 uppercase tracking-widest mb-4 pl-1 drop-shadow-sm">Maintenance / Out <span className="ml-2 bg-black/40 border border-white/10 text-white px-2 py-0.5 rounded-full text-[10px] shadow-inner">{maintenanceList.length}</span></h3><div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5">{maintenanceList.map(truck => (<TruckCard key={truck.id} truck={truck} drivers={currentDrivers} onUpdate={updateTruck} onDelete={deleteTruck} onClick={() => setViewingTruckId(truck.id)}/>))}</div></div></div>
                                    </>
                                )}
                            </div>
                        )}
                        {activeTab === 'tasks' && (<TaskBoard tasks={tasks} onAddTask={addTask} onToggleTask={toggleTask} onDeleteTask={deleteTask} />)}
                        {activeTab === 'schedule' && (<WeeklyCalendar drivers={currentDrivers} exceptions={exceptions} routes={routes} onUpdateDriverSchedule={updateDriverSchedule} />)}
                        {activeTab === 'routes' && (<RouteBoard drivers={currentDrivers} routes={routes} onUpdateRoute={updateRoute} onDeleteRoute={deleteRoute} currentDepot={currentDepot} />)}
                        {activeTab === 'compactors' && (<CompactorBoard customers={customers} issues={compactorIssues} onAddCustomer={addCustomer} onDeleteCustomer={deleteCustomer} onViewCustomer={setViewingCustomerId} onArchiveCustomer={archiveCustomer} onRestoreCustomer={restoreCustomer} />)}
                        {activeTab === 'docs' && (<GeneralDocsBoard documents={generalDocuments} onUploadDocument={uploadGeneralDoc} onDeleteDocument={deleteGeneralDoc} />)}
                    </main>
                    <ChatWidget />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
